% % \subsection{Термални оператори}

% Вече дефинирахме как на всеки терм $\tau[\vv{x}_1,\dots,\vv{x}_n,\vv{f}_1,\dots,\vv{f}_k]$
% съпоставяме изображението $\val{\tau}$ със сигнатура
% \[\val{\tau}:\Mapping{\Nat^{m_1}_\bot}{\Nat_\bot}\times\cdots\times\Mapping{\Nat^{m_k}_\bot}{\Nat_\bot} \to \Mapping{\Nat^n_\bot}{\Nat_\bot}\]

% Едно от основните свойства, които трябва да притежават тези изображения е да бъдат {\em непрекъснати} относно областите на Скот,
% за които са дефинирани.
% Причината за това е, че искаме да дефинираме семантиката на една програма като използваме най-малкото решение 
% на система от такива оператори, а според \hyperref[th:knaster-tarski]{Теоремата на Клини}, за да можем да направим това, трябва да работим
% с непрекъснати оператори. Следващият пример ни показва, че трябва да сме по-внимателни върху какви елементи разглеждаждаме тези изображения.

% \begin{example}
%   \label{ex:non-continuous}
%   Да разгледаме терма 
%   \[\tau[\vv{x},\vv{f},\vv{g}] \dfff \vv{f}(\vv{g}(\vv{x})),\]
%   и следните две изображения от тип $\Mapping{\Nat_\bot}{\Nat_\bot}$:
%   \marginpar{Обърнете внимание, че $\varphi$ не е монотонна функция. Тя дори не е точна. 
%     Функцията $\psi$ не е точна, но е монотонна. Знаем, че $\varphi$ не е непрекъсната}
%   \begin{align*}
%     & \varphi(x) \dff
%     \begin{cases}
%       42,   & \text{ако }x = \bot\\
%       \bot, & \text{ако }x \in \Nat
%     \end{cases}\\
%     & \psi(x) \dff 42 \text{, за всяко }x \in \Nat_\bot.
%   \end{align*}
%   Лесно се вижда, че $\pair{\varphi,\varphi} \sqsubseteq \pair{\varphi,\psi}$, но
%   \[\val{\tau}(\varphi,\varphi) \not\sqsubseteq \val{\tau}(\varphi,\psi),\]
%   защото за произволно $a \in \Nat$,
%   \begin{align*}
%     \val{\tau}(\varphi,\varphi)(a) & = \varphi(\varphi(a)) & \comment{\text{стойност на терм}}\\
%                                  & = 42  \\
%                                  & \not\sqsubseteq \bot & \comment{\text{плоска наредба}}\\
%                                  & = \varphi(\psi(a)) & \comment{\text{защото }\psi(a) \neq \bot}\\
%                                  & = \val{\tau}(\varphi,\psi)(a) & \comment{\text{от деф. на }\tau}\\
%   \end{align*}

%   \marginpar{Знаем, че всеки непрекъснат оператор е монотонен. Щом $\val{\tau}$ не е монотонен, то той със сигурност не е непрекъснат.}
%   Това означава, че за конкретния терм $\tau$, изображението $\val{\tau}$ не е монотонно, откъдето следва, че то не е непрекъснато.
% \end{example}

% % Горният пример ни казва, че за $\val{\tau}$, дефинирани върху произволни елементи от $\Mapping{\Nat^{m_i}_\bot}{\Nat_\bot}$
% % {\em не можем да гарантираме свойството непрекъснатост}. Ще видим, че ако се ограничим само до непрекъснатите изображения,
% % то тогава операторите ще бъдат непрекъснати.
% Всъщност на нас е необходимо да можем да подаваме като аргументи на $\val{\tau}$ само такива $\varphi$,
% които можем да дефинираме на езика \REC.
% Според семантиката на термовете, която дефинирахме по-горе, не е ясно дали можем да дефинираме терм на езика \REC, чиято семантика да бъде изображението $\varphi$. Естествено е да разгледаме терма 
% \[\tau[\vv{x}] \dfff \ifelse{\vv{x}\ \vv{==}\ \bot}{42}{\bot}.\]
% \marginpar{Това {\em не} е доказателство, че не можем да дефинираме функцията $\varphi$ на езика \REC. Тук ние твърдим само, че очевидният опит за дефиниция на $\varphi$ се проваля. По-нататък ще видим, че наистина не може да дефинираме $\varphi$ на нашия език, защото тя не е непрекъсната функция.}
%  Каква е семантиката на този терм? Следваме дефиницията на стойност на терм, за произволно $a \in \Nat_\bot$, и получаваме:
%  \begin{align*}
%    \val{\tau}(a) & =
%                    \begin{cases}
%                      42,   & \text{ако }\val{\vv{x}\ \vv{==}\ \bot}(a) \in \Nat^+\\
%                      \bot, & \text{ако }\val{\vv{x}\ \vv{==}\ \bot}(a) = 0\\
%                      \bot, & \text{ако }\val{\vv{x}\ \vv{==}\ \bot}(a) = \bot\\
%                    \end{cases}\\
%                  & = 
%                    \begin{cases}
%                      42,   & \text{ако }\underbrace{\val{\vv{x}}(a)}_{\in\Nat} = \underbrace{\val{\bot}(a)}_{\in \Nat}\\
%                      \bot, & \text{ако }\underbrace{\val{\vv{x}}(a)}_{\in\Nat} \neq \underbrace{\val{\bot}(a)}_{\in \Nat}\\
%                      \bot, & \text{ако }\val{\vv{x}}(a) = \bot\text{ или }\val{\bot}(a) = \bot\\
%                    \end{cases}\\
%                  & = \bot.
%  \end{align*}
 
% Да видим, какво ще стане ако преведем директно горния пример на \vv{хаскел}.
% \begin{haskellcode}
% ghci> let phi(x) = if x == undefined then 42 else undefined
% ghci> let psi(x) = 42
% ghci> phi(0)
% *** Exception: Prelude.undefined
% ghci> phi(undefined)
% *** Exception: Prelude.undefined
% ghci> psi(0)
% 42
% \end{haskellcode}

% Виждаме, че тук \texttt{хаскел} следва нашата семантика за езика {\bf REC}.
% Направените по-горе бележки ни насочват към следната дефиниция на {\bf термален оператор}.

% \begin{framed}
%   \begin{definition}
%     \index{термален оператор}
%     За всеки терм от вида $\tau[\vv{x}_1,\dots,\vv{x}_n, \vv{f}_1,\dots,\vv{f}_k]$
%     дефинираме оператора 
%     \[\Gamma_\tau: \DomOpCBN \to \RanOpCBN,\] % като
%     където
%     \[\Gamma_\tau(\bar{\varphi})(\bar{a}) \dff \val{\tau}(\ov{\varphi})(\ov{a}).\]
%   \end{definition}
% \end{framed}
% \marginpar{Обърнете внимание, че все още не е ясно защо $\Gamma_\tau(\ov{\varphi}) \in \RanOpCBN$}
% В следващия раздел ще се концентрираме върху доказателството на следния основен резултат:

% \begin{framed}
%   За всеки терм $\tau[\varsx, \varsf]$, операторът $\Gamma_\tau$ е непрекъснат.
% \end{framed}

\subsection{Непрекъснатост на термалните оператори}


\marginpar{Спокойно, след като докажем следващите две леми, няма да има нужда никога повече да правим такива сложни преобразувания.}
\begin{example}
  Да разгледаме терма $\tau[f_1,f_2,x] \equiv f_1(x) + f_2(x)$.
  Да видим какво представлява $\val{\tau}$.
  
  \begin{align*}
    \val{f_1(x) + f_2(x)}(\varphi,\psi)(a) & = \plus(\val{f_1(x)}(\varphi,\psi)(a),\val{f_2(x)}(\varphi,\psi)(a)) \\
                                           & = \plus(\varphi(a),\psi(a))\\
                                           & = (\plus \circ (\varphi \times \psi))(a)\\
                                           & = (\compose (\plus, \varphi \times \psi))(a).
  \end{align*}
  Или казано по-накратко,
  \[\val{\tau}(\varphi,\psi) = \compose (\plus, \varphi \times \psi).\]

  Оттук веднага се вижда, че ако $\varphi$ и $\psi$ са непрекъснати, то и $\val{\tau}(\varphi,\psi)$
  също ще е непрекъснато изображение, т.е. $\val{\tau}(\varphi,\psi) \in \Cont{\Nat_\bot}{\Nat_\bot}$.

  Можем да видим, че самото изображение $\val{\tau}$ също е непрекъснато, т.е.
  \[\val{\tau} \in \Cont{\Cont{\Nat_\bot}{\Nat_\bot}\times\Cont{\Nat_\bot}{\Nat_\bot}}{\Cont{\Nat_\bot}{\Nat_\bot}}.\]
  За да направим това е достатъчно да си припомним основните непрекъснати изображения, които разгледахме в първа глава и да съобразим следното:
  \[\val{\tau}(\varphi,\psi)  = \compose(\plus, \texttt{cross}(\varphi,\psi)).\]
  Тогава за произволни вериги $\chain{\varphi}{i}$ и $\chain{\psi}{i}$ е изпълнено, че:
  \begin{align*}
    \val{\tau}(\bigsqcup_i\varphi_i,\bigsqcup_i\psi_i) & = \compose(\plus, \texttt{cross}(\bigsqcup_i\varphi_i,\bigsqcup_i\psi_i))\\
                                                       & = \compose(\plus, \bigsqcup_i \texttt{cross}(\varphi_i,\psi_i))\\
                                                       & = \bigsqcup_i\compose(\plus, \texttt{cross}(\varphi_i,\psi_i))\\
                                                       & = \bigsqcup_i\val{\tau}(\varphi_i,\psi_i).
  \end{align*}
  % А какво изображение съответства на терма $\tau[f_1,f_2,x_1,x_2] \equiv f_1(x_1) + f_2(x_2)$?
  % Нека да съобразим, че
  % \begin{align*}
  %   & \varphi(a) = (\varphi \circ \texttt{fst})(a,b)\\
  %   & \psi(b) = (\psi \circ \texttt{snd})(a,b).
  % \end{align*}
  % Оттук получаваме, че
  % \begin{align*}
  %   \val{f_1(x_1) + f_2(x_2)}(\varphi,\psi)(a,b) & = \plus(\val{f_1(x_1)}(\varphi,\psi)(a,b),\val{f_2(x_2)}(\varphi,\psi)(a,b)) \\
  %                                                & = \plus(\varphi(a),\psi(b))\\
  %                                                & = \plus((\varphi \circ \texttt{fst})(a,b),(\psi\circ \texttt{snd})(a,b))\\
  %                                                & = (\plus \circ ((\varphi\circ\texttt{fst}) \times (\psi\circ\texttt{snd})))(a,b).
  % \end{align*}
  % Оттук се вижда, че можем да получим следното представяне:
  % \[\val{f_1(x_1) + f_2(x_2)}(\varphi,\psi) = \plus \circ ((\varphi\circ\texttt{fst}) \times (\psi\circ\texttt{snd})).\]
  % От това представяне на $\val{\tau}$ е ясно, че ако $\varphi$ и $\psi$ са непрекъснати изображения, то
  % $\val{\tau}(\varphi,\psi)$ също е непрекъснато изображение.
  % Можем да видим и нещо по-силно, а именно, че самото изображение $\val{\tau}$ е непрекъснато. С други думи,
  % \[\val{\tau} : \Cont{\Cont{\Nat_\bot}{\Nat_\bot} \times \Cont{\Nat_\bot}{\Nat_\bot}}{\Cont{\Nat^2_\bot}{\Nat_\bot}}.\]
  % Това е така, защото самите операции $\compose$ и $\texttt{cross}$ са непрекъснати и защото
  % \[\val{\tau}(\varphi,\psi) = \compose(\plus, \texttt{cross}(\compose(\varphi,\texttt{fst}), \compose(\psi,\texttt{snd})))\]
  % и тогава за произволни вериги $\chain{\varphi}{i}$ и $\chain{\psi}{i}$ е изпълнено, че:
  % \begin{align*}
  %   \val{\tau}(\bigsqcup_i\varphi_i,\bigsqcup_i\psi_i) & = \compose(\plus, \texttt{cross}(\compose(\bigsqcup_i\varphi_i,\texttt{fst}), \compose(\bigsqcup_i\psi_i,\texttt{snd})))\\
  %                                                      & =  \compose(\plus, \texttt{cross}(\bigsqcup_i\compose(\varphi_i,\texttt{fst}), \bigsqcup_i\compose(\psi_i,\texttt{snd})))\\
  %                                                      & =  \compose(\plus, \bigsqcup_i\texttt{cross}(\compose(\varphi_i,\texttt{fst}), \compose(\psi_i,\texttt{snd})))\\
  %                                                      & =  \bigsqcup_i\compose(\plus, \texttt{cross}(\compose(\varphi_i,\texttt{fst}), \compose(\psi_i,\texttt{snd})))\\
  %                                                      & = \bigsqcup_i \val{\tau}(\varphi_i,\psi_i).
  % \end{align*}
\end{example}


% Първата ни задача ще бъде да проверим, че операторът $\Gamma_\tau$ е коректно дефиниран.
% Това означава, че трябва да се уверим, че винаги когато подадем като аргументи на $\Gamma_\tau$ непрекъснати изображения,
% то $\Gamma_\tau$ връща непрекъснато изображение.

\marginpar{В този раздел всички доказателства се провеждат с индукция по построението на термовете.}

Сега ще видим, че разсъжденията, които направихме в горния пример могат да се обобщят за всеки терм.

\begin{proposition}
  \label{pr:term-monotone}
  За всеки терм $\tau[\vv{x}_1,\dots,\vv{x}_n, \vv{f}_1,\dots,\vv{f}_k]$
  и произволно 
  \marginpar{Озн. $\ov{a}_i = (a^1_i,\dots,a^n_i)$. Тук можеше да искаме и $\varphi_i \in \Mon{\Nat^{m_i}_\bot}{\Nat_\bot}$.}
  % Нека $\ov{a} \sqsubseteq \ov{b}$.
  % Тогава 
  % \[\val{\tau}(\ov{\varphi})(\ov{a}) \sqsubseteq \val{\tau}(\ov{\varphi})(\ov{b}),\]
  % където
  $\varphi_i \in \Cont{\Nat^{m_i}_\bot}{\Nat_\bot}$, за $i = 1,\dots,k$,
  е изпълнено, че
  \[\val{\tau}(\ov{\varphi}) \in \Cont{\Nat^{n}_\bot}{\Nat_\bot}.\]
\end{proposition}
\begin{hint}
  Индукция по построението на терма $\tau$.
  \begin{itemize}
  \item
    \marginpar{$\texttt{const}^n_a \in \Cont{\Nat^n_\bot}{\Nat_\bot}$.}
    Нека $\tau \equiv \vv{a}$. Тогава
    \[\val{\tau}(\ov{\varphi}) = \texttt{const}^{n}_a.\]
  \item
    \marginpar{$\texttt{proj}^{\Nat_\bot,n}_i \in \Cont{\Nat^n_\bot}{\Nat_\bot}$}
    Нека $\tau \equiv \vv{x}_i$. Тогава
    \[\val{\tau}(\ov{\varphi}) = \texttt{proj}^{\Nat_\bot,n}_i.\]
  \item
    Нека $\tau \equiv \tau_1 + \tau_2$.
    \marginpar{
      За произволно $\ov{a} \in \Nat^n_\bot$,
      \begin{align*}
        & \val{\tau_1+\tau_2}(\ov{\varphi})(\ov{a}) = \\
        & \plus(\val{\tau_1}(\ov{\varphi})(\ov{a}), \val{\tau_2}(\ov{\varphi})(\ov{a})) = \\
        & \plus((\val{\tau_1}(\ov{\varphi}) \times \val{\tau_2}(\ov{\varphi}))(\ov{a})) = \\
        & (\plus \circ (\val{\tau_1}(\ov{\varphi}) \times \val{\tau_2}(\ov{\varphi})))(\ov{a}).
      \end{align*}
}
    Можем лесно да съобразим, че
    \[\val{\tau_1\ \vv{+}\ \tau_2}(\ov{\varphi}) = \plus \circ (\val{\tau_1}(\ov{\varphi}) \times \val{\tau_2}(\ov{\varphi})).\]
    Първо, от \IndHyp имаме, че $\val{\tau_1}(\ov{\varphi})$ и $\val{\tau_2}(\ov{\varphi})$ са непрекъснати.
    От \Prop{cartesian-product:pair-continuous} знаем, $\val{\tau_1}(\ov{\varphi}) \times \val{\tau_2}(\ov{\varphi})$ е непрекъснато изображение. И накрая, понеже $\plus$ е непрекъснато, и композицията запазва непрекъснатостта, то целия израз
    $\plus \circ (\val{\tau_1}(\ov{\varphi}) \times \val{\tau_2}(\ov{\varphi}))$ е непрекъснато изображение.
    % Тук ще използваме, че от {\bf И.П.}, за $j = 1,2$, имаме
    % \begin{equation}
    %   \label{eq:10}
    %   \val{\tau_j}(\ov{\varphi})(\ov{a}) \sqsubseteq \val{\tau_j}(\ov{\varphi})(\ov{b}).
    % \end{equation}    
    % Освен това, понеже изображението $\texttt{plus}$ е непрекъснато, то то е и монотонно.
    % \begin{align*}
    %   \val{\tau}(\ov{\varphi})(\ov{a}) & = \val{\tau_1 + \tau_2}(\ov{\varphi})(\ov{a})\\
    %                                    & \df \texttt{plus}(\val{\tau_1}(\ov{\varphi})(\ov{a}), \val{\tau_2}(\ov{\varphi})(\ov{a}))\\
    %                                    & \sqsubseteq \texttt{plus}(\val{\tau_1}(\ov{\varphi})(\ov{b}), \val{\tau_2}(\ov{\varphi})(\ov{b})) & \comment{\text{от (\ref{eq:10}) и мон.}}\\
    %   & \df \val{\tau_1 + \tau_2}(\ov{\varphi})(\ov{b}).
    % \end{align*}
  \item
    Нека $\tau \equiv \tau_1 - \tau_2$.
    Ясно е, че
    \[\val{\tau_1\ -\ \tau_2}(\ov{\varphi}) = \minus \circ (\val{\tau_1}(\ov{\varphi}) \times \val{\tau_2}(\ov{\varphi})).\]

  \item
    % \marginpar{\writedown За домашно!}
    Нека $\tau \equiv \tau_1\ \vv{==}\ \tau_2$.
    Ясно е, че
    \[\val{\tau_1 \vv{==} \tau_2}(\ov{\varphi}) = \eq \circ (\val{\tau_1}(\ov{\varphi}) \times \val{\tau_2}(\ov{\varphi})).\]    
  \item
    Нека $\tau \equiv \ifelse{\tau_0}{\tau_1}{\tau_2}$.
    Ясно е, че
    \[\val{\ifelse{\tau_1}{\tau_2}{\tau_3}}(\ov{\varphi}) = \texttt{if}_{\Nat_\bot} \circ (\val{\tau_1}(\ov{\varphi}) \times \val{\tau_2}(\ov{\varphi}) \times \val{\tau_3}(\ov{\varphi})).\]
  \item
    Нека $\tau \equiv \vv{f}_i(\tau_1,\dots,\tau_{m_i})$.
    Ясно е, че
    \[\val{\vv{f}_i(\tau_1,\dots,\tau_{m_i})}(\ov{\varphi}) \df \varphi_i \circ (\val{\tau_1}(\ov{\varphi}) \times \dots \times \val{\tau_{m_i}}(\ov{\varphi})).\]
    % Тук ще използваме, че от {\bf И.П.}, за $j = 1,\dots,m_i$, имаме
    % \begin{equation}
    %   \label{eq:6}
    %   \val{\tau_j}(\ov{\varphi})(\ov{a}) \sqsubseteq \val{\tau_j}(\ov{\varphi})(\ov{b}).
    % \end{equation}
    % Тогава
    % \begin{align*}
    %   \val{\tau}(\ov{\varphi})(\ov{a}) & = \val{\vv{f}_i(\tau_1,\dots,\tau_{m_i})}(\ov{\varphi})(\ov{a})\\
    %                                   & = \varphi_i(\val{\tau_1}(\ov{\varphi})(\ov{a}), \dots, \val{\tau_{m_i}}(\ov{\varphi})(\ov{a})) & \comment\text{от деф.}\\
    %                                   & \sqsubseteq \varphi_i(\val{\tau_1}(\ov{\varphi})(\ov{b}), \dots, \val{\tau_{m_i}}(\ov{\varphi})(\ov{b})) & \comment{\text{от (\ref{eq:6}) и $\varphi_i$ е мон.}}\\
    %                                   & = \val{\tau}(\ov{\varphi})(\ov{b}). & \comment\text{от деф.}
    % \end{align*}
  \end{itemize}
\end{hint}

% \begin{corollary}
%   \label{cr:tau-preserves-continuous}
%   Да разгледаме един терм $\tau[\vv{x}_1,\dots,\vv{x}_n, \vv{f}_1,\dots,\vv{f}_k]$.
%   Тогава за произволна верига $\chain{\bar{a}}{i}$ в $\Nat^{n}_\bot$,
%   \[\val{\tau}(\ov{\varphi})(\bigsqcup_i\ov{a}_i) = \bigsqcup_i\val{\tau}(\ov{\varphi})(\ov{a}_i),\]
%   където
%   $\varphi_i \in \Cont{\Nat^{n_i}_\bot}{\Nat_\bot}$, за $i = 1,\dots,k$.
% \end{corollary}
% \begin{proof}
%   Да разгледаме произволен терм $\tau$ и непрекъснати изображения $\ov{\varphi}$.
%   От \Prop{term-monotone} следва, че $\val{\tau}(\ov{\varphi}) \in \Mon{\Nat^n_\bot}{\Nat_\bot}$.
%   Понеже всяка верига в $\Nat^n_\bot$ се стабилизира, то директно от \Prop{stab-continuous}
%   следва, че $\val{\tau}(\ov{\varphi}) \in \Cont{\Nat^n_\bot}{\Nat_\bot}$,
%   което означава, че за произволна верига $\chain{\ov{a}}{i}$,
%   \[\val{\tau}(\ov{\varphi})(\bigsqcup_i\ov{a}_i) = \bigsqcup_i\val{\tau}(\ov{\varphi})(\ov{a}_i).\]
% \end{proof}

% \begin{corollary}\label{cr:gamma-preserves-continuous}
%   Да разгледаме произволен терм $\tau[\vv{x}_1,\dots,\vv{x}_n, \vv{f}_1,\dots,\vv{f}_k]$.
%   Тогава за произволни $\varphi_i \in \Cont{\Nat^{m_i}}{\Nat_\bot}$, за $i = 1,\dots k$,
%   имаме, че
%   \[\val{\tau}(\bar\varphi) \in \RanOpCBN.\]
% \end{corollary}
% \begin{proof}
%   Понеже всяка верига в $\Nat^n_\bot$ се стабилизира, то $\Mon{\Nat^n_\bot}{\Nat_\bot} = \Cont{\Nat^{n}}{\Nat_\bot}$.
% \end{proof}


% Щом термалните оператори $\val{\tau}$ са добре дефинирани, ще 
% проверим, че са непрекъснати. Първата стъпка ще бъде проверката, че те са монотонни.


\begin{lemma}\label{lem:rec:functional:term:continuous}
  Нека $\tau[\vv{x}_1,\dots,\vv{x}_n,\vv{f}_1,\dots,\vv{f}_k]$ е произволен терм.
  \marginpar{Да напомним, че $m_i \df \sharp\vv{f}_i$}
  Да разгледаме произволна верига $\chain{\ov{\varphi}}{r}$
  от елементи на областта на Скот $\DomOpCBN$.
  Тогава $\val{\tau}$ е непрекъснато изображение, т.е.
  \[\val{\tau}(\bigsqcup_r\ov{\varphi}_r) = \bigsqcup_r \val{\tau}(\ov{\varphi}_r).\]
\end{lemma}
\begin{proof}
  Индукция по построението на терма $\tau$.
  \begin{itemize}
  \item
    Нека $\tau \equiv \vv{a}$. Този случай е очевиден.
  \item
    Нека $\tau \equiv \vv{x}_i$.
  \item
    Нека $\tau \equiv \tau_1 + \tau_2$. Ще използваме, че $\plus$ е непрекъснато изображение.
    % \begin{align*}
    %   \val{\tau}(\bigsqcup_r \ov{\varphi}_r)(\ov{a}) & = \plus(\val{\tau_1}(\bigsqcup_r\ov{\varphi}_r)(\ov{a}), \val{\tau_2}(\bigsqcup_r\ov{\varphi}_r)(\ov{a})) & \comment\text{от деф.}\\
    %                                          & = \plus(\bigsqcup_r\val{\tau_1}(\ov{\varphi}_r)(\ov{a}), \bigsqcup_r \val{\tau_2}(\ov{\varphi}_r)(\ov{a})) & \comment{\text{от И.П.}}\\
    %                                          & = \bigsqcup_r \plus(\val{\tau_1}(\ov{\varphi}_r)(\ov{a}), \val{\tau_2}(\ov{\varphi}_r)(\ov{a})) & \comment{\plus\text{ е непр.}}\\
    %                                          & = \bigsqcup_r \val{\tau}(\ov{\varphi}_r)(\ov{a}). & \comment\text{от деф.}
    % \end{align*}
    Тогава:
    \begin{align*}
      \val{\tau}(\bigsqcup_r \ov{\varphi}_r) & = \plus \circ (\val{\tau_1}(\bigsqcup_r\ov{\varphi}_r) \times \val{\tau_2}(\bigsqcup_r\ov{\varphi}_r)) & \comment\text{от деф.}\\
                                             & = \compose (\plus, \texttt{cross}(\val{\tau_1}(\bigsqcup_r\ov{\varphi}_r), \val{\tau_2}(\bigsqcup_r\ov{\varphi}_r)))\\
                                             & = \compose (\plus, \texttt{cross}(\bigsqcup_r \val{\tau_1}(\ov{\varphi}_r), \bigsqcup_r \val{\tau_2}(\ov{\varphi}_r))) & \comment\text{\IndHyp}\\
                                             & = \compose (\plus, \bigsqcup_r \texttt{cross}(\val{\tau_1}(\ov{\varphi}_r), \val{\tau_2}(\ov{\varphi}_r))) & \comment \texttt{cross}\text{ е непр.}\\
                                             & = \bigsqcup_r \compose (\plus, \texttt{cross}(\val{\tau_1}(\ov{\varphi}_r), \val{\tau_2}(\ov{\varphi}_r))) & \comment \compose\text{ е непр.}\\
                                             & = \bigsqcup_r \val{\tau}(\ov{\varphi}_r). & \comment\text{от деф.}
    \end{align*}
  \item
    Нека $\tau \equiv \tau_1\ \vv{-}\ \tau_2$.
    Използвайте, че $\minus$ е непрекъснато изображение според \Problem{basic-operations:continuous}.
  \item
    Нека $\tau \equiv \tau_1\ \vv{==}\ \tau_2$.
    Използвайте, че $\eq$ е непрекъснато изображение според \Problem{basic-operations:continuous}.
  \item
    Нека $\tau \equiv \ifelse{\tau_0}{\tau_1}{\tau_2}$.
    Използвайте, че $\texttt{if}_{\Nat_\bot}$ е непрекъснато според \Problem{basic-operations:if:continuous}.
  \item
    Нека $\tau \equiv \vv{f}_i(\tau_1,\dots,\tau_{m_i})$.
    Тук ще използваме, че $\compose$ и $\texttt{cross}$ са непрекъснати според \Problem{composition:continuous} и \Problem{cross:continuous}.
    % От И.П. знаем, че $\val{\tau_j}$ са непрекъснати изображения за $j = 1,\dots,m_i$ и следователно са монотонни. Тогава
    % за произволни индекси $n \leq n'$ и $r \leq r'$ имаме, че
    % \marginpar{$\ov{\varphi}_n \df (\varphi^1_n,\dots,\varphi^{k}_n)$}
    % \begin{align*}
    %   \varphi^i_{n}(\val{\tau_1}(\ov{\varphi}_r)(\ov{a}),\dots,\val{\tau_{m_i}}(\ov{\varphi}_r)(\ov{a})) & \sqsubseteq \varphi^i_{n}(\val{\tau_1}(\ov{\varphi}_{r'})(\ov{a}),\dots,\val{\tau_{m_i}}(\ov{\varphi}_{r'})(\ov{a}))\\
    %                                                                                    & \sqsubseteq \varphi^i_{n'}(\val{\tau_1}(\ov{\varphi}_{r'})(\ov{a}),\dots,\val{\tau_{m_i}}(\ov{\varphi}_{r'})(\ov{a})).
    % \end{align*}
    % Това означава, че ако положим
    % \[e_{n,r} \df \varphi^i_{n}(\val{\tau_1}(\ov{\varphi}_r)(\ov{a}),\dots,\val{\tau_{m_i}}(\ov{\varphi}_r)(\ov{a})),\]
    % то е изпълнена импликацията:
    % \[n \leq n'\ \&\ r \leq r' \implies e_{n,r} \sqsubseteq e_{n',r'}.\]
    % Сега можем да приложим \Th{double-chain}, според която
    % \begin{equation}
    %   \label{eq:8}
    %   \bigsqcup_n(\bigsqcup_r e_{n,r}) = \bigsqcup_n e_{n,n}.
    % \end{equation}

    % Тогава 
    % \begin{align*}
    %   \val{\tau}(\bigsqcup_n\ov{\varphi}_n)(\ov{a}) & = \val{\vv{f}_i(\tau_1,\dots,\tau_{m_i})}(\bigsqcup_n\ov{\varphi}_n)(\ov{a})\\
    %                                                 & = (\bigsqcup_n\varphi^i_n)(\val{\tau_1}(\bigsqcup_r\ov{\varphi}_r)(\ov{a}),\dots,\val{\tau_{m_i}}(\bigsqcup_r\ov{\varphi}_r)(\ov{a})) & \comment\text{от деф.}\\
    %                                                 & = \bigsqcup_n \{\varphi^i_n(\val{\tau_1}(\bigsqcup_r\ov{\varphi}_r)(\ov{a}),\dots,\val{\tau_{m_i}}(\bigsqcup_r\ov{\varphi}_r)(\ov{a}))\} & \comment{\text{от \Th{monotone-is-domain}}}\\
    %                                        & =  \bigsqcup_n \{\varphi^i_n(\bigsqcup_r \val{\tau_1}(\ov{\varphi}_r)(\ov{a}),\dots,\bigsqcup_r \val{\tau_{m_i}}(\ov{\varphi}_r)(\ov{a}))\} & \comment{\text{от И.П. за }\tau_j}\\
    %                                        & =  \bigsqcup_n \{\bigsqcup_r \underbrace{\varphi^i_n(\val{\tau_1}(\ov{\varphi}_r)(\ov{a}),\dots,\val{\tau_{m_i}}(\ov{\varphi}_r)(\ov{a}))}_{e_{n,r}}\} & \comment{\varphi^i_n \text{ е непр.}}\\
    %                                        & =  \bigsqcup_n \underbrace{\varphi^i_n(\val{\tau_1}(\ov{\varphi}_n)(\ov{a}),\dots,\val{\tau_{m_i}}(\ov{\varphi}_n)(\ov{a}))}_{e_{n,n}} & \comment{\text{от (\ref{eq:8})}}\\
    %                                        & = \bigsqcup_n \val{\vv{f}_i(\tau_1,\dots,\tau_{m_i})}(\ov{\varphi}_n)(\ov{a}) & \comment\text{от деф.}\\
    %                                        & = \bigsqcup_n \val{\tau}(\ov{\varphi}_n)(\ov{a}).
    % \end{align*}

    % \marginpar{От \Prop{composition:continuous} знаем, че $\compose$ е непрекъснато изображение.}
    Тогава:
    \begin{align*}
      \val{\tau}(\bigsqcup_n\ov{\varphi}_n) & = \val{\vv{f}_i(\tau_1,\dots,\tau_{m_i})}(\bigsqcup_n\ov{\varphi}_n) & \comment{\ov{\varphi}_n = (\varphi^1_n,\dots,\varphi^k_n)}\\
                                            & = (\bigsqcup_n\varphi^i_n) \circ (\val{\tau_1}(\bigsqcup_r\ov{\varphi}_r) \times \cdots \times \val{\tau_{m_i}}(\bigsqcup_r\ov{\varphi}_r)) & \comment\text{деф. на }\val{\tau}\\
                                            & = \compose(\bigsqcup_n\varphi^i_n, \texttt{cross}(\val{\tau_1}(\bigsqcup_r\ov{\varphi}_r), \dots, \val{\tau_{m_i}}(\bigsqcup_r\ov{\varphi}_r))\\
                                            & = \compose(\bigsqcup_n\varphi^i_n, \texttt{cross}(\bigsqcup_r \val{\tau_1}(\ov{\varphi}_r), \dots, \bigsqcup_r\val{\tau_{m_i}}(\ov{\varphi}_r)) & \comment\text{от \IndHyp}\\
                                            & = \compose(\bigsqcup_n\varphi^i_n, \bigsqcup_r \texttt{cross}(\val{\tau_1}(\ov{\varphi}_r), \dots, \val{\tau_{m_i}}(\ov{\varphi}_r)) & \comment\texttt{cross}\text{ е непр.}\\
                                            & = \bigsqcup_r \compose(\varphi^i_r, \texttt{cross}(\val{\tau_1}(\ov{\varphi}_r), \dots, \val{\tau_{m_i}}(\ov{\varphi}_r))) & \comment\compose\text{ е непр.}\\
                                            & = \bigsqcup_r \varphi^i_r(\val{\tau_1}(\ov{\varphi}_r), \dots, \val{\tau_{m_i}}(\ov{\varphi}_r))\\
                                            & = \bigsqcup_r \val{\vv{f}_i(\tau_1,\dots,\tau_{m_i})}(\ov{\varphi}_r)\\
                                            & = \bigsqcup_r \val{\tau}(\ov{\varphi}_r).
    \end{align*}
    
  \end{itemize}
\end{proof}

% \begin{corollary}
%   \label{cr:rec:term:continuous}
%   Нека $\tau[\varsx,\varsf]$ е терм.
%   Да разгледаме произволни елементи $\ov{a}$ на $\Nat^n_\bot$ и 
%   произволна верига $\chain{\ov{\varphi}}{r}$
%   от елементи на $\DomOpCBN$.
%   Тогава 
%   \[\val{\tau}(\bigsqcup_r\ov{\varphi}_r)(\ov{a}) = \bigsqcup_r \val{\tau}(\ov{\varphi}_r)(\ov{a}).\]  
% \end{corollary}
% \begin{proof}
%   \marginpar{Тук има проблем! Някои от $\ov{a}$ може да е $\bot$.}
%   \begin{align*}
%     \val{\tau}(\bigsqcup_r\ov{\varphi}_r)(\ov{a}) & = \val{\tau[\varsx/\ov{\vv{a}}]}(\bigsqcup_r \ov{\varphi}_r) & \comment{\text{от \hyperref[lem:rec:substitution]{Лема за замяната}}}\\
%                                                   & = \bigsqcup_r \val{\tau[\varsx/\ov{\vv{a}}]}(\ov{\varphi}_r) & \comment{\text{от \Lem{rec:functional:term:continuous}}}\\
%                                                   & = \bigsqcup_r \val{\tau}(\ov{\varphi}_r)(\ov{a}) &  \comment{\text{от \hyperref[lem:rec:substitution]{Лема за замяната}}}\\
%   \end{align*}
% \end{proof}

% Вече имаме всичко необходимо за да се убедим, че термалните оператори са непрекъснати.


Оттук нататък, можем да сме сигурни, че ако едно изображение може да се дефинира като терм на езика \FUN,
то със сигурност това изображение е непрекъснато.

\begin{framed}
\begin{theorem}
  \label{th:gamma-is-continuous}
  За всеки терм $\tau[\vv{x}_1,\dots,\vv{x}_n, \vv{f}_1,\dots,\vv{f}_k]$, имаме, че
  \[\val{\tau} \in \Cont{\DomOpCBN}{\RanOpCBN}.\]
\end{theorem}
\end{framed}
% \begin{proof}
%   От \Cor{gamma-preserves-continuous} имаме, че $\Gamma_\tau$ е коректно дефиниран.
%   Сега директно се позоваваме на \Cor{rec:term:continuous}.
% \end{proof}


%%% Local Variables:
%%% mode: latex
%%% TeX-master: "../sep"
%%% End:
