\section{Адекватност}
\marginpar{Adequacy ???}
Нашата цел в този раздел е да докажем следната теорема.
\begin{framed}
  \begin{theorem}[Теорема за адекватност]
    За всеки затворен терм $\tau : \vv{nat}$, 
    \[\val{\tau} = n \neq \bot \implies \tau \Downarrow_{\vv{nat}} \vv{n}.\]
  \end{theorem}
\end{framed}
\marginpar{Тук $n$ е число, а $\vv{n}$ е константа.}

Оказва се, че доказателството на тази теорема не е леко.
Ще започнем като дефинираме за всеки тип $\vv{a}$ релацията 
$\triangleleft_{\vv{a}} \subseteq \val{\vv{a}} \times \vv{PCF}_{\vv{a}}$
с индукция по построението на типовете.

\begin{itemize}
\item
  \marginpar{Съобразете, че теоремата за адекватност на практика гласи, че $\val{\tau} \triangleleft_{\vv{nat}} \tau$.}
  Нека $\vv{a} = \vv{nat}$. Тогава дефинираме
  \[n \triangleleft_{\vv{nat}} \tau \iff ( n\neq\bot^{\val{\vv{nat}}} \implies \tau \Downarrow_{\vv{nat}} \vv{n}).\]
\item
  Нека $\vv{a} = \vv{b} \to \vv{c}$. Тогава дефинираме
  \[f \triangleleft_{\vv{b}\to\vv{c}} \tau \iff (\forall e\in \val{\vv{b}})(\forall \mu \in \vv{PCF}_{\vv{b}})[\ e \triangleleft_{\vv{b}} \mu \implies f(e) \triangleleft_{\vv{c}} \tau(\mu)\ ].\]
\item
  Нека $\Gamma = \vv{x}_1:\vv{a}_1, \dots, \vv{x}_n:\vv{a}_n$. Тогава дефинираме 
  \[(u_1,\dots,u_n) \triangleleft_\Gamma (\tau_1,\dots,\tau_n) \iff u_1 \triangleleft_{\vv{a}_1} \tau_1\ \&\ \cdots\ \&\ u_n \triangleleft_{\vv{a}_n} \tau_n.\]
\end{itemize}

\begin{lemma}\label{lem:pcf:relation}
  \marginpar{\cite[стр. 197]{gunter}}
  Нека $\tau : \vv{a}$. Тогава:
  \begin{enumerate}[1)]
  \item
    $\bot^{\val{\vv{a}}} \triangleleft_{\vv{a}} \tau$;
  \item
    $D = \{d \in \val{\vv{a}} \mid d \triangleleft_{\vv{a}} \tau\}$ е непрекъснато свойство в областта на Скот $\val{\vv{a}}$;
  \item
    \marginpar{Не ми трябва $u \sqsubseteq d$.}
    Ако $d \triangleleft_{\vv{a}} \tau$ и $(\forall \vv{v})[\tau \Downarrow_{\vv{a}} \vv{v} \implies \rho
    \Downarrow_{\vv{a}} \vv{v}]$, то $d \triangleleft_{\vv{a}} \rho$.
  \end{enumerate}
\end{lemma}
\begin{proof}
  Индукция по построението на типовете $\vv{a}$.
  Първо, нека $\vv{a} = \vv{nat}$ и да фиксираме произволен терм $\tau : \vv{nat}$.
  \marginpar{Да напомним, че $\val{\vv{nat}} \df \Nat_\bot$.}
  \begin{enumerate}[1)]
  \item
    По тривиални съображения имаме, че
    \[\bot^{\val{\vv{nat}}} \triangleleft_{\vv{nat}} \tau.\]
  \item
    Нека $\chain{d}{i}$ е верига от елементи на $\Nat_\bot$ и за всяко $i$, $d_i \triangleleft_{\vv{nat}} \tau$.
    Ако за всяко $i$, $d_i = \bot$, то $\bigsqcup_i d_i = \bot^{\val{\vv{nat}}}$ и следователно $\bigsqcup_i d_i
    \triangleleft_{\vv{nat}} \tau$.
    Ако съществува $i_0$, за което $d_{i_0} = n \neq \bot$, то е ясно, че за всяко $i > i_0$, $d_i = n$.
    Оттук следва, че $\bigsqcup_i d_i = n = d_{i_0}$.
    Понеже $d_{i_0} \triangleleft_{\vv{nat}} \tau$, то директно следва, че $\bigsqcup_i d_i \triangleleft_{\vv{nat}} \tau$.
  \item
    Нека $d \triangleleft_{\vv{nat}} \tau$ и $(\forall \vv{v})[\tau \Downarrow_{\vv{nat}} \vv{v} \implies \rho
    \Downarrow_{\vv{nat}} \vv{v}]$. Понеже $\sqsubseteq$ е плоската наредба в $\Nat_\bot$, то имаме два случая.
    Ако $d = \bot^{\val{\vv{nat}}}$, то е ясно от 1), че $d \triangleleft_{\vv{nat}} \rho$.
    Нека сега $d \neq \bot^{\val{\vv{nat}}}$. 
    Понеже $d \triangleleft_{\vv{nat}} \tau$, то $\tau \Downarrow_{\vv{nat}} \vv{d}$.
    Оттук следва, че $\rho \Downarrow_{\vv{nat}} \vv{d}$. Заключаваме, че $d \triangleleft_{\vv{nat}} \rho$.    
  \end{enumerate}
  
  Второ, ека $\vv{a} = \vv{b} \to \vv{c}$ и да фиксираме произволен терм $\tau : \vv{b} \to \vv{c}$.
  \marginpar{Да напомним, че \[\val{\vv{b} \to \vv{c}} \df \Cont{\val{\vv{b}}}{\val{\vv{c}}}.\]}
  \begin{enumerate}[1)]
  \item
    Тук имаме, че $\bot^{\val{\vv{a}}} \in \Cont{\val{\vv{b}}}{\val{\vv{c}}}$ е изображение,
    за което $\bot^{\val{\vv{a}}}(e) =  \bot^{\val{\vv{c}}}$ за всеки елемент $e \in \val{\vv{b}}$.
    Нека $e \triangleleft_{\vv{b}} \mu$, където $\mu : \vv{b}$.
    От правилата за типизиране е ясно, че $\tau(\mu) : \vv{c}$.
    Сега от И.П. е ясно, че $\bot^{\val{\vv{a}}}(e) = \bot^{\val{\vv{c}}} \triangleleft_{\vv{c}} \tau(\mu)$.
  \item
    Нека $\chain{f}{i}$ е верига от елементи на $\Cont{\val{\vv{b}}}{\val{\vv{c}}}$,
    за които е изпълнено, че $f_i \triangleleft_{\vv{a}} \tau$. Трябва да докажем, че $\bigsqcup_i f_i \triangleleft_{\vv{a}} \tau$,
    т.е. за произволни $e \in \val{\vv{b}}$ и произволни $\mu : \vv{b}$, за които $e \triangleleft_{\vv{b}} \mu$, то
    $(\bigsqcup_if)(e) \triangleleft_{\vv{c}} \tau(\mu)$.
    Но ние знаем, че $(\bigsqcup_if)(e) = \bigsqcup_i\{f_i(e)\}$.
    Щом $f_i \triangleleft_{\vv{b}\to\vv{c}} \tau$, то за разглежданите $e$ и $\mu$ имаме, че $f_i(e) \triangleleft_{\vv{c}} \tau(\mu)$.
    Ние знаем, че ${(f_i(e))}^\infty_{i=0}$ е верига и от И.П. следва, че $\bigsqcup_i\{f_i(e)\} \triangleleft_{\vv{c}} \tau(\mu)$.
  \item
    Нека $f \triangleleft_{\vv{b}\to\vv{c}} \tau$ и $\tau \Downarrow_{\vv{b}\to\vv{c}} \vv{v} \implies \rho
    \Downarrow_{\vv{b}\to\vv{c}} \vv{v}$. Ще докажем, че $f \triangleleft_{\vv{b} \to \vv{c}} \rho$.
    За целта, нека $e \in \val{\vv{b}}$, $\mu : \vv{b}$ и $e \triangleleft_{\vv{b}} \mu$.
    Ще докажем, че $f(e) \triangleleft_{\vv{c}} \rho(\mu)$.
    За момента знаем само, че $f(e) \triangleleft_{\vv{c}} \tau(\mu)$.
    Понеже имаме следното правило в операционната семантика:
    \marginpar{Имаме по условие, че 
      \[\tau \Downarrow_{\vv{b}\to\vv{c}} \vv{v} \implies \rho \Downarrow_{\vv{b}\to\vv{c}} \vv{v},\] а тук $\vv{v} \equiv \lamb{x}{b}{\tau'}$.}
    \begin{prooftree}
      \AxiomC{$\tau \Downarrow_{\vv{b}\to\vv{c}} \lamb{x}{b}{\tau'}$}
      \AxiomC{$\tau'\subst{x}{\mu} \Downarrow_{\vv{c}} \vv{v}'$}
      \RightLabel{\scriptsize{(app)}}
      \BinaryInfC{$\tau(\mu) \Downarrow_{\vv{c}} \vv{v}'$}
    \end{prooftree}
    то получаваме, че
    \begin{prooftree}
      \AxiomC{$\rho \Downarrow_{\vv{b}\to\vv{c}} \lamb{x}{b}{\tau'}$}
      \AxiomC{$\tau'\subst{x}{\mu} \Downarrow_{\vv{c}} \vv{v}'$}
      \RightLabel{\scriptsize{(app)}}
      \BinaryInfC{$\rho(\mu) \Downarrow_{\vv{c}} \vv{v}'$}
    \end{prooftree}
    Оттук следва, че
    \[(\forall \vv{v}')[\tau(\mu) \Downarrow_{\vv{c}} \vv{v}' \implies \rho(\mu) \Downarrow_{\vv{c}} \vv{v}'].\]
    Сега от И.П. директно следва, че $f(e) \triangleleft_{\vv{c}} \rho(\mu)$.
  \end{enumerate}
\end{proof}

За да докажем, че $\val{\tau} \triangleleft_{\vv{nat}} \tau$, то трябва да докажем, че за всеки тип $\vv{a}$ и всеки $\tau \in \vv{PCF}_{\vv{a}}$
$\val{\tau} \triangleleft_{\vv{a}} \tau$ с индукция по построението на термовете.
Тук обаче имаме проблем. Ако $\tau \equiv \lamb{y}{b}{\tau_1}$, то трябва да използваме индукционно предположение за $\tau_1$,
в който вече има свободна променлива $\vv{y}$. Поради тази причина, ние трябва да разгледаме едно по-общо твърдение.

\begin{framed}
  \begin{lemma}[Фундаментално свойство на $\triangleleft_{\vv{a}}$]\label{lem:pcf:fundamental}
    Нека $\Gamma = \vv{x}_1:\vv{a}_1,\dots,\vv{x}_n:\vv{a}_n$. Тогава
    \begin{prooftree}
      \AxiomC{$\Gamma \vdash \tau : \vv{a}$}
      \AxiomC{$(u_1,\dots,u_n) \triangleleft_\Gamma (\mu_1,\dots,\mu_n)$}
      \BinaryInfC{$\val{\tau}_\Gamma(\ov{u}) \triangleleft_{\vv{a}} \tau[\ov{\vv{x}}/\ov{\mu}]$}
    \end{prooftree}
  \end{lemma}  
\end{framed}
\begin{proof}
  Индукция по построението на термовете.
  \begin{itemize}
  \item
    Нека $\tau \equiv \vv{n}$. Тук директно от дефиницията на релацията $\triangleleft_{\vv{nat}}$ имаме, че
    \[n \triangleleft_{\vv{nat}} \vv{n}.\]
  \item
    Нека $\tau \equiv \vv{x}_i$. Този случай също е много лесен.
    Имаме, че $\tau[\ov{x}/\ov{\mu}] \equiv \mu_i$ и $\val{\tau}_\Gamma(\ov{u}) = u_i$.
    Тогава, понеже $(u_1,\dots,u_n) \triangleleft_\Gamma (\mu_1,\dots,\mu_n)$,
    то директно получаваме, че
    \[\val{\tau}_\Gamma(\ov{u}) \triangleleft_{\vv{a}} \tau[\ov{x}/\ov{\mu}].\]
  \item
    Нека $\tau \equiv \tau_1 + \tau_2$. Тогава $\vv{a} = \vv{nat}$. Имаме също, че
    \begin{align*}
      & \tau[\ov{x}/\ov{\mu}] \equiv \tau_1[\ov{x}/\ov{\mu}] + \tau_2[\ov{x}/\ov{\mu}];\\
      & \val{\tau}_\Gamma(\ov{u}) = \texttt{plus}(\underbrace{\val{\tau_1}_\Gamma(\ov{u})}_{n_1},\underbrace{\val{\tau_2}_\Gamma(\ov{u})}_{n_2}) = n.
    \end{align*}
    Можем да приемем, че $n \neq \bot$, защото в противен случай този случай е тривиален заради дефиницията на $\triangleleft_{\vv{nat}}$.
    От И.П. имаме, че $\val{\tau_1}_\Gamma(\ov{u}) \triangleleft_{\vv{nat}} \tau_1[\ov{x}/\ov{\mu}]$
    и $\val{\tau_2}_\Gamma(\ov{u}) \triangleleft_{\vv{nat}} \tau_2[\ov{x}/\ov{\mu}]$.
    Това означава, че $\tau_1[\ov{x}/\ov{\mu}] \Downarrow_{\vv{nat}} \vv{n}_1$ и $\tau_2[\ov{x}/\ov{\mu}] \Downarrow_{\vv{nat}}
    \vv{n}_2$.
    От правилата на операционната семантика е ясно, че $\tau[\ov{x}/\ov{\mu}] \Downarrow_{\vv{nat}} \vv{n}$ и следователно
    \[\val{\tau}_\Gamma(\ov{u}) \triangleleft_{\vv{a}} \tau[\ov{\vv{x}}/\ov{\mu}].\]
  \item
    Нека $\tau \equiv \tau_1\ \vv{==}\ \tau_2$. 
  \item
    Нека $\tau \equiv \ifelse{\tau_1}{\tau_2}{\tau_3}$.
  \item
    Нека $\tau \equiv \tau_1\tau_2$. От правилата за типизиране имаме, че
    \begin{prooftree}
      \AxiomC{$\Gamma \vdash \tau_1 : \vv{b} \to \vv{a}$}
      \AxiomC{$\Gamma \vdash \tau_2 : \vv{b}$}
      \BinaryInfC{$\Gamma \vdash \tau_1\tau_2 : \vv{a}$}
    \end{prooftree}
    Да напомним, че
    \[\val{\tau_1\tau_2}_\Gamma(\ov{u}) \df \texttt{eval}(\val{\tau_1}_\Gamma(\ov{u}), \val{\tau_2}_\Gamma(\ov{u})).\]
    От И.П. имаме следното:
    \begin{align*}
      & \val{\tau_1}_\Gamma(\ov{u}) \triangleleft_{\vv{b}\to\vv{a}} \tau_1[\ov{x}/\ov{\mu}];\\
      & \val{\tau_2}_\Gamma(\ov{u}) \triangleleft_{\vv{b}} \tau_2[\ov{x}/\ov{\mu}].
    \end{align*}
    Тогава директно следва, че
    \[\texttt{eval}(\val{\tau_1}_\Gamma(\ov{u}), \val{\tau_2}_\Gamma(\ov{u})) \triangleleft_{\vv{a}} \tau_1[\ov{x}/\ov{\mu}](\tau_2[\ov{x}/\ov{\mu}])\]
  \item
    Нека $\tau = \lamb{y}{b}{\tau'}$. Тогава от правилата за типизиране следва, че $\vv{a} = \vv{b} \to \vv{c}$ и
    $\Gamma' \vdash \tau' : \vv{c}$, където $\Gamma' = \Gamma, \type{y}{b}$.
    Да напомним, че
    \[\val{\tau}_\Gamma(\ov{u}) \df \texttt{curry}(\val{\tau'}_{\Gamma'})(\ov{u}) \in \Cont{\val{\vv{b}}}{\val{\vv{c}}}.\]
    Да положим $f \df \val{\tau}_\Gamma(\ov{u})$. Тогава $f(e) = \val{\tau'}(\ov{u},e)$.
    
    Трябва да докажем, че $f \triangleleft_{\vv{b} \to \vv{c}} \tau[\ov{x}/\ov{\mu}]$.
    Това означава, че за произволни $e \in \val{\vv{b}}$ и $\rho : \vv{b}$, за които $e \triangleleft_{\vv{b}} \rho$,
    трябва да докажем, че $f(e) \triangleleft_{\vv{c}} \tau[\ov{x}/\ov{\mu}](\rho)$.
    Имаме, че
    \begin{prooftree}
      \AxiomC{$\Gamma' \vdash \tau' : \vv{c}$}
      \AxiomC{$(u_1,\dots,u_n,e) \triangleleft_{\Gamma'} (\mu_1,\dots,\mu_n,\rho)$}
      \RightLabel{\scriptsize{(И.П.)}}
      \BinaryInfC{$\val{\tau'}(\ov{u},e) \triangleleft_{\vv{c}} \tau'[\ov{x}/\ov{\mu}][y/\rho]$}
      \UnaryInfC{$f(e) \triangleleft_{\vv{c}} \tau'[\ov{x}/\ov{\mu}][y/\rho]$}
    \end{prooftree}
    От правилата на операционната семантика имаме следното:
    \begin{prooftree}
      \AxiomC{$\emptyset \vdash \rho : \vv{b}$}
      \AxiomC{$\tau'[\ov{x}/\ov{\mu}][y/\rho] \Downarrow_{\vv{c}} \vv{v}$}
      \BinaryInfC{$(\lamb{y}{b}{\tau'[\ov{x}/\ov{\mu}]})(\rho) \Downarrow_{\vv{c}} \vv{v}$}
      \UnaryInfC{$\tau[\ov{x}/\ov{\mu}](\rho) \Downarrow_{\vv{c}} \vv{v}$}
    \end{prooftree}
    От 3) на \Lem{pcf:relation} веднага заключаваме, че $f(e) \triangleleft_{\vv{c}} \tau[\ov{x}/\ov{\mu}](\rho)$.
  \item
    Нека $\tau \equiv \fix(\tau')$. Тогава от правилата за типизиране имаме, че $\Gamma \vdash \tau' : \vv{a} \to \vv{a}$.
    От И.П., приложено за $\tau'$, имаме, че
    \[\val{\tau'}(\ov{u}) \triangleleft_{\vv{a}\to\vv{a}} \tau'[\ov{x}/\ov{\mu}].\]
    Нека за улеснение да положим $f \df \val{\tau'}(\ov{u}) \in \Cont{\val{\vv{a}}}{\val{\vv{a}}}$.
    Да напомним, че
    \[\val{\fix(\tau')}_\Gamma(\ov{u}) = \lfp(f)\]
    От 2) на \Lem{pcf:relation} знаем, че
    \[D = \{d \in \val{\vv{a}} \mid d \triangleleft_{\vv{a}} \fix(\tau'[\ov{x}/\ov{\mu}])\}\]
    е непрекъснато свойство. Целта ни е да докажем, че
    $\lfp(f) \in D$. Ще направим това като приложим правилото на Скот.
    Да напомним, че
    \begin{prooftree}
      \AxiomC{$\bot^{\val{\vv{a}}} \in D$}
      \AxiomC{$d \in D \implies f(d) \in D$}
      \BinaryInfC{$\lfp(f) \in D$}
    \end{prooftree}
    Понеже от 1) на \Lem{pcf:relation} имаме, че $\bot^{\val{\vv{a}}} \in D$, то
    нека вземем произволен елемент $d \in D$. Ще докажем, че $f(d) \in D$.

    Понеже $f \triangleleft_{\vv{a}\to\vv{a}} \tau'[\ov{x}/\ov{\mu}]$, то
    за произволно $e \triangleleft_{\vv{a}} \rho$ е изпълнено, че
    $f(e) \triangleleft_{\vv{a}} \tau'[\ov{x}/\ov{\mu}](\rho)$.
    Нека изберем $\rho = \fix(\tau'[\ov{x}/\ov{\mu}])$. Щом $d \in D$, то $d \triangleleft_{\vv{a}} \rho$ и следователно
    \[f(d) \triangleleft_{\vv{a}} \tau'[\ov{x}/\ov{\mu}](\underbrace{\fix(\tau'[\ov{x}/\ov{\mu}])}_{\rho}).\]
    От правилата на операционната семантика имаме, че:
    \begin{prooftree}
      \AxiomC{$\tau'[\ov{x}/\ov{\mu}](\fix(\tau'[\ov{x}/\ov{\mu}])) \Downarrow_{\vv{a}} \vv{v}$}
      \RightLabel{\scriptsize{(fix)}}
      \UnaryInfC{$\fix(\tau'[\ov{x}/\ov{\mu}]) \Downarrow_{\vv{a}} \vv{v}$}
    \end{prooftree}
    Тогава от 3) на \Lem{pcf:relation} следва, че
    \[f(d) \triangleleft_{\vv{a}} \fix(\tau'[\ov{x}/\ov{\mu}]).\]
    Така доказахме, че $f(d) \in D$.
    Заключаваме, че $\lfp(f) \in d$, т.е.
    \[\val{\fix(\tau')}_\Gamma(\ov{u}) \triangleleft_{\vv{a}} \fix(\tau'[\ov{x}/\ov{\mu}])\]
  \end{itemize}
\end{proof}

\begin{corollary}\label{cr:pcf:fundamental}
  За всеки тип $\vv{a}$,
  \[\tau \in \text{PCF}_{\vv{a}} \implies \val{\tau} \triangleleft_{\vv{a}} \tau.\]
\end{corollary}

Вече на практика доказахме теоремата за адекватност.

\begin{framed}
  \begin{theorem}[Теорема за адекватност]\label{th:pcf:adequacy}
    За всеки затворен терм $\tau : \vv{nat}$, 
    \[\val{\tau} = n \neq \bot \implies \tau \Downarrow_{\vv{nat}} \vv{n}.\]
  \end{theorem}
\end{framed}
\begin{proof}
  Да разгледаме произволен затворен терм $\tau : \vv{nat}$.
  Нека $\val{\tau} = n \neq \bot$.
  От \Cor{pcf:fundamental} имаме, че $\val{\tau} \triangleleft_{\vv{nat}} \tau$.
  Тогава от дефиницията на $\triangleleft_{\vv{nat}}$ получаваме, че $\tau \Downarrow_{\vv{nat}} \vv{n}$.
\end{proof}

\begin{corollary}
  За всеки $\tau \in \text{PCF}_{\vv{nat}}$,
  \[\tau \not\Downarrow_{\vv{nat}}\ \implies\ \val{\tau} = \bot^{\val{\vv{nat}}}.\]  
\end{corollary}


Но както видяхме в Пример~\ref{pcf:ex:no-adequacy-high-types} не можем да обобщим тази импликация за по-високи типове.
Това означава, че нашата семантика не е напълно ,,добра'' в смисъл, че $\bot^{\val{\vv{a}}}$ елементът не
отговаря на нашата интуиция за безкрайно изчисление за всеки тип $\vv{a}$.


%%% Local Variables:
%%% mode: latex
%%% TeX-master: "../sep"
%%% End:
