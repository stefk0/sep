\section{Адекватност}
\marginpar{Adequacy ???}
Нашата цел в този раздел е да докажем следната теорема.
\begin{framed}
  \begin{theorem}[Теорема за адекватност]
    За всеки затворен терм $\tau : \vv{nat}$ е изпълнена импликацията
    \[\val{\tau} = n \neq \bot^{\val{\nat}} \implies \tau \Downarrow_{\vv{nat}} \vv{n}.\]
  \end{theorem}
\end{framed}
\marginpar{Тук $n$ е число, а $\vv{n}$ е константа.}

Оказва се, че доказателството на тази теорема не е леко.
Ще започнем като дефинираме за всеки тип $\vv{a}$ релацията 
$\triangleleft_{\vv{a}} \subseteq \val{\vv{a}} \times \vv{PCF}_{\vv{a}}$
с индукция по построението на типовете.

\begin{itemize}
\item
  \marginpar{Съобразете, че теоремата за адекватност на практика гласи, че $\val{\tau} \triangleleft_{\vv{nat}} \tau$.}
  Нека $\vv{a} = \vv{nat}$. Тогава 
  \marginpar{Обикновено $\triangleleft_{\vv{a}}$ се нарича \emph{логическа релация}.
    В \cite[стр. 210]{models-of-computation} е обяснено защо имаме нужда от тези релации за да докажем теоремата за адекватност. В \cite[стр. 134]{gunter} е представен синтактичен подход към решаването на този проблем.}
  \[n \triangleleft_{\vv{nat}} \tau \dff ( n\neq\bot^{\val{\vv{nat}}} \implies \tau \Downarrow_{\vv{nat}} \vv{n}).\]
\item
  Нека $\vv{a} = \vv{b} \to \vv{c}$. Тогава 
  \[f \triangleleft_{\vv{b}\to\vv{c}} \tau \dff (\forall e\in \val{\vv{b}})(\forall \mu \in \vv{PCF}_{\vv{b}})[\ e \triangleleft_{\vv{b}} \mu \implies f(e) \triangleleft_{\vv{c}} \tau(\mu)\ ].\]
\item
  Нека $\Gamma = \vv{x}_1:\vv{a}_1, \dots, \vv{x}_n:\vv{a}_n$. Тогава 
  \[(u_1,\dots,u_n) \triangleleft_\Gamma (\tau_1,\dots,\tau_n) \dff u_1 \triangleleft_{\vv{a}_1} \tau_1\ \&\ \cdots\ \&\ u_n \triangleleft_{\vv{a}_n} \tau_n.\]
\end{itemize}

\begin{example}
  Да проверим внимателно защо е изпълнено, че:
  \[\texttt{id}_{\val{\nat}} \triangleleft_{\vv{nat}\to\vv{nat}} \lamb{x}{nat}{\vv{x + 0}}.\]
  Според дефиницията трябва да проверим импликацията
  \[e \triangleleft_{\nat} \mu \implies \texttt{id}_{\val{\nat}}(e) \triangleleft_{\nat} \tau(\mu),\]
  за произволен елемент $e \in \Nat_\bot$ и произволен затворен терм $\mu : \nat$.
  \marginpar{Аналогично можем да видим, че $\texttt{id}_{\val{\nat}} \triangleleft_{\nat} \lamb{x}{nat}{x}$.}
  \begin{itemize}
  \item
    Ако $e = \bot$, то от дефиницията на $\triangleleft_{\nat}$ ведната следва, че за произволен затворен терм $\mu : \nat$, то
    $\bot \triangleleft_{\nat} \mu$. Понеже $\texttt{id}_{\val{\nat}}(\bot) = \bot$, то отново от дефиницията веднага следва, че
    $\bot \triangleleft_{\nat} \tau(\mu)$, за произволен затворен терм $\mu : \nat$.
  \item
    Нека $e = n\in\Nat$ и да разгледаме затворен терм $\mu : \nat$, за който $n \triangleleft_{\nat} \mu$.
    Според дефиницията на $\triangleleft_{\nat}$, това означава, че $\mu \opsem{}{nat} \vv{n}$.
    Сега да видим защо $\texttt{id}_{\val{\nat}}(n) = n \triangleleft_{\nat} \tau(\mu)$ или с други думи,
    трябва да проверим, че $\tau(\mu) \opsem{}{nat} \vv{n}$. Тук се позоваваме на правилата от операционната семантика:
    \begin{prooftree}
      \AxiomC{$\tau$ е стойност}
      \LeftLabel{\scriptsize{(val)}}
      \UnaryInfC{$\tau \opsemGen{}{\nat\to\nat} \lamb{x}{nat}{\vv{x + 0}}$}
      \AxiomC{$n \triangleleft_{\nat} \mu$}
      \UnaryInfC{$\mu \opsem{}{nat} \vv{n}$}
      \AxiomC{$\vv{0}$ е стойност}
      \RightLabel{\scriptsize{(val)}}
      \UnaryInfC{$\vv{0} \opsem{}{nat} \vv{0}$}
      \RightLabel{\scriptsize{(plus)}}
      \BinaryInfC{$\vv{(x+0)}\subst{x}{\mu} \opsem{}{nat} \vv{n}$}
      \RightLabel{\scriptsize{(app)}}
      \BinaryInfC{$\tau(\mu) \opsem{}{nat} \vv{n}$}
    \end{prooftree}
  \end{itemize}

\end{example}

\begin{problem}
  Нека положим $\tau \equiv \lamb{x}{nat}{\lamb{y}{nat}{x-y}}$.
  Проверете, че $f \triangleleft_{\nat\to\nat\to\nat} \tau$, където:
  \begin{itemize}
  \item
    $f = \curry(\minus)$;
  \item
    $f(a)(b) =
    \begin{cases}
      a-b, & \text{ако }a \geq b\\
      \bot, & \text{иначе}
    \end{cases}$;
  \item
    $f(a)(b) = \bot$ за произволни $a,b\in\Nat_\bot$.
  \end{itemize}
\end{problem}


Нека първо да разгледаме някои основни свойства на релацията $\triangleleft_{\vv{a}}$.
Тук доказателствата протичат с индукция по построението на типовете.
\marginpar{\cite[стр. 197]{gunter}}

\begin{proposition}\label{pr:pcf:adequacy:bottom}
  За всеки тип $\vv{a}$ и всеки затворен терм $\tau : \vv{a}$ е изпълнено, че $\bot^{\val{\vv{a}}} \triangleleft_{\vv{a}} \tau$.
\end{proposition}
\begin{proof}
  Индукция по построението на типовете $\vv{a}$.
  Първо, нека $\vv{a} = \vv{nat}$. По тривиални съображения имаме, че за произволен терм $\tau:\vv{a}$ е изпълнено, че $\bot^{\val{\vv{nat}}} \triangleleft_{\vv{nat}} \tau$.
  
  Второ, нека $\vv{a} = \vv{b} \to \vv{c}$ и да фиксираме произволен терм $\tau : \vv{b} \to \vv{c}$.
  Тук имаме, че $\bot^{\val{\vv{a}}} \in \Cont{\val{\vv{b}}}{\val{\vv{c}}}$ е изображение,
  за което $\bot^{\val{\vv{a}}}(e) =  \bot^{\val{\vv{c}}}$ за всеки елемент $e \in \val{\vv{b}}$.
  Нека $e \triangleleft_{\vv{b}} \mu$, където $\mu : \vv{b}$.
  Щом $\tau : \vv{b}\to\vv{c}$, от правилата за типизиране е ясно, че $\tau(\mu) : \vv{c}$.
  Сега от \IndHyp за типа $\vv{c}$ е ясно, че $\bot^{\val{\vv{a}}}(e) = \bot^{\val{\vv{c}}} \triangleleft_{\vv{c}} \tau(\mu)$.
\end{proof}


\begin{proposition}\label{pr:pcf:adequacy:chain}
  Нека за произволен тип $\vv{a}$ и произволен терм $\tau:\vv{a}$ да разгледаме множеството $D \df \{d \in \val{\vv{a}} \mid d \triangleleft_{\vv{a}} \tau\}$.
  Тогава ако $\chain{d}{i}$ е верига от елементи на $D$, то $\bigsqcup_i d_i$ също принадлежи на $D$.
\end{proposition}
\begin{proof}
  Индукция по построението на типовете $\vv{a}$.
  Първо, нека $\vv{a} = \vv{nat}$.
  \marginpar{Да напомним, че $\val{\vv{nat}} = \Nat_\bot$. Ясно е, че всяка верига от елементи на $\Nat_\bot$ се стабилизира.}
  Нека $\chain{d}{i}$ е верига от елементи на $\Nat_\bot$ и за всеки индекс $i$, $d_i \triangleleft_{\vv{nat}} \tau$.
  Ако за всяко $i$, $d_i = \bot$, то $\bigsqcup_i d_i = \bot^{\val{\vv{nat}}}$ и следователно $\bigsqcup_i d_i
  \triangleleft_{\vv{nat}} \tau$.
  Ако съществува индекс $i_0$, за който $d_{i_0} = n \neq \bot$, то е ясно, че за всяко $i > i_0$, $d_i = n$.
  Оттук следва, че $\bigsqcup_i d_i = n = d_{i_0}$.
  Понеже $d_{i_0} \triangleleft_{\vv{nat}} \tau$, то директно следва, че $\bigsqcup_i d_i \triangleleft_{\vv{nat}} \tau$.

  Второ, нека $\vv{a} = \vv{b} \to \vv{c}$ и да фиксираме произволен терм $\tau : \vv{b} \to \vv{c}$.
  Нека $\chain{f}{i}$ е верига от елементи на $\Cont{\val{\vv{b}}}{\val{\vv{c}}}$,
  за които е изпълнено, че $f_i \triangleleft_{\vv{a}} \tau$. Трябва да докажем, че $\bigsqcup_i f_i \triangleleft_{\vv{a}} \tau$,
  т.е. за произволен елемент $e \in \val{\vv{b}}$ и произволен затворен терм $\mu : \vv{b}$, за който $e \triangleleft_{\vv{b}} \mu$, то
  $(\bigsqcup_if)(e) \triangleleft_{\vv{c}} \tau(\mu)$.
  Но ние знаем от \Lem{double-chain:lub}, че $(\bigsqcup_if)(e) = \bigsqcup_i\{f_i(e)\}$.
  Щом $f_i \triangleleft_{\vv{b}\to\vv{c}} \tau$, то за разглежданите $e$ и $\mu$ имаме, че $f_i(e) \triangleleft_{\vv{c}} \tau(\mu)$.
  Ние знаем, че ${(f_i(e))}^\infty_{i=0}$ е верига и от \IndHyp за типа $\vv{c}$ следва, че $\bigsqcup_i\{f_i(e)\} \triangleleft_{\vv{c}} \tau(\mu)$.
\end{proof}


\begin{proposition}\label{pr:pcf:adequacy:implication}
  Да разгледаме произволен тип $\vv{a}$ и произволен затворен терм $\tau : \vv{a}$.
  \marginpar{Да напомним, че с $\vv{v}$ означаваме термове стойности.}
  Тогава е изпълнено следното:
  \begin{prooftree}
    \AxiomC{$d \triangleleft_{\vv{a}} \tau$}
    \AxiomC{$(\forall \vv{v})[\tau \Downarrow_{\vv{a}} \vv{v} \implies \rho \Downarrow_{\vv{a}} \vv{v}]$}
    \BinaryInfC{$d \triangleleft_{\vv{a}} \rho$}
  \end{prooftree}
\end{proposition}
\begin{proof}
  Индукция по построението на типовете $\vv{a}$.
  Първо, нека $\vv{a} = \vv{nat}$. 
  Нека $d \triangleleft_{\vv{nat}} \tau$ и $(\forall \vv{v})[\tau \Downarrow_{\vv{nat}} \vv{v} \implies \rho \Downarrow_{\vv{nat}} \vv{v}]$.
  Понеже $\sqsubseteq$ е плоската наредба в $\Nat_\bot$, то имаме два случая.
  Ако $d = \bot^{\val{\vv{nat}}}$, то е ясно от \Prop{pcf:adequacy:bottom}, че $d \triangleleft_{\vv{nat}} \rho$.
  Нека сега $d \neq \bot^{\val{\vv{nat}}}$. 
  Понеже $d \triangleleft_{\vv{nat}} \tau$, то $\tau \Downarrow_{\vv{nat}} \vv{d}$.
  Оттук следва, че $\rho \Downarrow_{\vv{nat}} \vv{d}$. Заключаваме, че $d \triangleleft_{\vv{nat}} \rho$.

  Второ, нека $\vv{a} = \vv{b} \to \vv{c}$ и да фиксираме произволен терм $\tau : \vv{b} \to \vv{c}$.
  Нека
  \begin{align}
    & f \triangleleft_{\vv{b}\to\vv{c}} \tau \label{eq:pcf:adequacy:implication:f-tau}\\
    & (\forall \vv{v})[\tau \Downarrow_{\vv{b}\to\vv{c}} \vv{v} \implies \rho \Downarrow_{\vv{b}\to\vv{c}} \vv{v}] \label{eq:pcf:adequacy:implication:value}
  \end{align}
  % $f \triangleleft_{\vv{b}\to\vv{c}} \tau$ и $(\forall \vv{v})[\tau \Downarrow_{\vv{b}\to\vv{c}} \vv{v} \implies \rho \Downarrow_{\vv{b}\to\vv{c}} \vv{v}]$.
  Ще докажем, че $f \triangleleft_{\vv{b} \to \vv{c}} \rho$.
  За целта, да разгледаме произволен елемент $e \in \val{\vv{b}}$ и произволен затворен терм $\mu : \vv{b}$, за който $e \triangleleft_{\vv{b}} \mu$.
  Достатъчно е да докажем, че $f(e) \triangleleft_{\vv{c}} \rho(\mu)$.
  За момента от Свойство~(\ref{eq:pcf:adequacy:implication:f-tau}) знаем само, че $f(e) \triangleleft_{\vv{c}} \tau(\mu)$.
  Понеже имаме следното правило в операционната семантика:
  \marginpar{Имаме от (\ref{eq:pcf:adequacy:implication:value}), че 
    \[\tau \Downarrow_{\vv{b}\to\vv{c}} \vv{v} \implies \rho \Downarrow_{\vv{b}\to\vv{c}} \vv{v},\] а тук $\vv{v} \equiv \lamb{x}{b}{\tau'}$.}
  \begin{prooftree}
    \AxiomC{$\tau \Downarrow_{\vv{b}\to\vv{c}} \overbrace{\lamb{x}{b}{\tau'}}^{\vv{v}}$}
    \AxiomC{$\tau'\subst{x}{\mu} \Downarrow_{\vv{c}} \vv{v}'$}
    \RightLabel{\scriptsize{(app)}}
    \BinaryInfC{$\tau(\mu) \Downarrow_{\vv{c}} \vv{v}'$}
  \end{prooftree}
  то от Свойство~(\ref{eq:pcf:adequacy:implication:value}) получаваме, че
  \begin{prooftree}
    \AxiomC{$\rho \Downarrow_{\vv{b}\to\vv{c}} \overbrace{\lamb{x}{b}{\tau'}}^{\vv{v}}$}
    \AxiomC{$\tau'\subst{x}{\mu} \Downarrow_{\vv{c}} \vv{v}'$}
    \RightLabel{\scriptsize{(app)}}
    \BinaryInfC{$\rho(\mu) \Downarrow_{\vv{c}} \vv{v}'$}
  \end{prooftree}
  Оттук следва, че
  \begin{equation}
    \label{eq:pcf:adequacy:implication:final}
    (\forall \vv{v}')[\tau(\mu) \Downarrow_{\vv{c}} \vv{v}' \implies \rho(\mu) \Downarrow_{\vv{c}} \vv{v}'].
  \end{equation}
  Сега от \IndHyp за типа $\vv{c}$ директно следва, че щом $f(e) \triangleleft_{\vv{c}}\tau(\mu)$ и Свойство (\ref{eq:pcf:adequacy:implication:final}), то \[f(e) \triangleleft_{\vv{c}} \rho(\mu).\]
\end{proof}




% \begin{lemma}\label{lem:pcf:relation}
%   Нека $\tau : \vv{a}$. Тогава:
%   \begin{enumerate}[1)]
%   \item
%     $\bot^{\val{\vv{a}}} \triangleleft_{\vv{a}} \tau$;
%   \item
%     $D = \{d \in \val{\vv{a}} \mid d \triangleleft_{\vv{a}} \tau\}$ е непрекъснато свойство в областта на Скот $\val{\vv{a}}$, т.е.
%     за всяка верига $\chain{d}{i}$ от елементи на $D$ е изпълнено, че $\bigsqcup_i d_i \in D$.
%   \item
%     \marginpar{Не ми трябва $u \sqsubseteq d$.}
%     Ако $d \triangleleft_{\vv{a}} \tau$ и $(\forall \vv{v})[\tau \Downarrow_{\vv{a}} \vv{v} \implies \rho
%     \Downarrow_{\vv{a}} \vv{v}]$, то $d \triangleleft_{\vv{a}} \rho$.
%   \end{enumerate}
% \end{lemma}
% \begin{proof}
%   Индукция по построението на типовете $\vv{a}$.
%   Първо, нека $\vv{a} = \vv{nat}$ и да фиксираме произволен терм $\tau : \vv{nat}$.
%   \marginpar{Да напомним, че $\val{\vv{nat}} \df \Nat_\bot$.}
%   \begin{enumerate}[1)]
%   \item
%     По тривиални съображения имаме, че
%     \[\bot^{\val{\vv{nat}}} \triangleleft_{\vv{nat}} \tau.\]
%   \item
%     Нека $\chain{d}{i}$ е верига от елементи на $\Nat_\bot$ и за всяко $i$, $d_i \triangleleft_{\vv{nat}} \tau$.
%     Ако за всяко $i$, $d_i = \bot$, то $\bigsqcup_i d_i = \bot^{\val{\vv{nat}}}$ и следователно $\bigsqcup_i d_i
%     \triangleleft_{\vv{nat}} \tau$.
%     Ако съществува $i_0$, за което $d_{i_0} = n \neq \bot$, то е ясно, че за всяко $i > i_0$, $d_i = n$.
%     Оттук следва, че $\bigsqcup_i d_i = n = d_{i_0}$.
%     Понеже $d_{i_0} \triangleleft_{\vv{nat}} \tau$, то директно следва, че $\bigsqcup_i d_i \triangleleft_{\vv{nat}} \tau$.
%   \item
%     Нека $d \triangleleft_{\vv{nat}} \tau$ и $(\forall \vv{v})[\tau \Downarrow_{\vv{nat}} \vv{v} \implies \rho
%     \Downarrow_{\vv{nat}} \vv{v}]$. Понеже $\sqsubseteq$ е плоската наредба в $\Nat_\bot$, то имаме два случая.
%     Ако $d = \bot^{\val{\vv{nat}}}$, то е ясно от 1), че $d \triangleleft_{\vv{nat}} \rho$.
%     Нека сега $d \neq \bot^{\val{\vv{nat}}}$. 
%     Понеже $d \triangleleft_{\vv{nat}} \tau$, то $\tau \Downarrow_{\vv{nat}} \vv{d}$.
%     Оттук следва, че $\rho \Downarrow_{\vv{nat}} \vv{d}$. Заключаваме, че $d \triangleleft_{\vv{nat}} \rho$.    
%   \end{enumerate}
  
%   Второ, нека $\vv{a} = \vv{b} \to \vv{c}$ и да фиксираме произволен терм $\tau : \vv{b} \to \vv{c}$.
%   \marginpar{Да напомним, че \[\val{\vv{b} \to \vv{c}} \df \Cont{\val{\vv{b}}}{\val{\vv{c}}}.\]}
%   \begin{enumerate}[1)]
%   \item
%     Тук имаме, че $\bot^{\val{\vv{a}}} \in \Cont{\val{\vv{b}}}{\val{\vv{c}}}$ е изображение,
%     за което $\bot^{\val{\vv{a}}}(e) =  \bot^{\val{\vv{c}}}$ за всеки елемент $e \in \val{\vv{b}}$.
%     Нека $e \triangleleft_{\vv{b}} \mu$, където $\mu : \vv{b}$.
%     От правилата за типизиране е ясно, че $\tau(\mu) : \vv{c}$.
%     Сега от И.П. е ясно, че $\bot^{\val{\vv{a}}}(e) = \bot^{\val{\vv{c}}} \triangleleft_{\vv{c}} \tau(\mu)$.
%   \item
%     Нека $\chain{f}{i}$ е верига от елементи на $\Cont{\val{\vv{b}}}{\val{\vv{c}}}$,
%     за които е изпълнено, че $f_i \triangleleft_{\vv{a}} \tau$. Трябва да докажем, че $\bigsqcup_i f_i \triangleleft_{\vv{a}} \tau$,
%     т.е. за произволни $e \in \val{\vv{b}}$ и произволни $\mu : \vv{b}$, за които $e \triangleleft_{\vv{b}} \mu$, то
%     $(\bigsqcup_if)(e) \triangleleft_{\vv{c}} \tau(\mu)$.
%     Но ние знаем, че $(\bigsqcup_if)(e) = \bigsqcup_i\{f_i(e)\}$.
%     Щом $f_i \triangleleft_{\vv{b}\to\vv{c}} \tau$, то за разглежданите $e$ и $\mu$ имаме, че $f_i(e) \triangleleft_{\vv{c}} \tau(\mu)$.
%     Ние знаем, че ${(f_i(e))}^\infty_{i=0}$ е верига и от И.П. следва, че $\bigsqcup_i\{f_i(e)\} \triangleleft_{\vv{c}} \tau(\mu)$.
%   \item
%     Нека $f \triangleleft_{\vv{b}\to\vv{c}} \tau$ и $\tau \Downarrow_{\vv{b}\to\vv{c}} \vv{v} \implies \rho
%     \Downarrow_{\vv{b}\to\vv{c}} \vv{v}$. Ще докажем, че $f \triangleleft_{\vv{b} \to \vv{c}} \rho$.
%     За целта, нека $e \in \val{\vv{b}}$, $\mu : \vv{b}$ и $e \triangleleft_{\vv{b}} \mu$.
%     Ще докажем, че $f(e) \triangleleft_{\vv{c}} \rho(\mu)$.
%     За момента знаем само, че $f(e) \triangleleft_{\vv{c}} \tau(\mu)$.
%     Понеже имаме следното правило в операционната семантика:
%     \marginpar{Имаме по условие, че 
%       \[\tau \Downarrow_{\vv{b}\to\vv{c}} \vv{v} \implies \rho \Downarrow_{\vv{b}\to\vv{c}} \vv{v},\] а тук $\vv{v} \equiv \lamb{x}{b}{\tau'}$.}
%     \begin{prooftree}
%       \AxiomC{$\tau \Downarrow_{\vv{b}\to\vv{c}} \lamb{x}{b}{\tau'}$}
%       \AxiomC{$\tau'\subst{x}{\mu} \Downarrow_{\vv{c}} \vv{v}'$}
%       \RightLabel{\scriptsize{(app)}}
%       \BinaryInfC{$\tau(\mu) \Downarrow_{\vv{c}} \vv{v}'$}
%     \end{prooftree}
%     то получаваме, че
%     \begin{prooftree}
%       \AxiomC{$\rho \Downarrow_{\vv{b}\to\vv{c}} \lamb{x}{b}{\tau'}$}
%       \AxiomC{$\tau'\subst{x}{\mu} \Downarrow_{\vv{c}} \vv{v}'$}
%       \RightLabel{\scriptsize{(app)}}
%       \BinaryInfC{$\rho(\mu) \Downarrow_{\vv{c}} \vv{v}'$}
%     \end{prooftree}
%     Оттук следва, че
%     \[(\forall \vv{v}')[\tau(\mu) \Downarrow_{\vv{c}} \vv{v}' \implies \rho(\mu) \Downarrow_{\vv{c}} \vv{v}'].\]
%     Сега от И.П. директно следва, че $f(e) \triangleleft_{\vv{c}} \rho(\mu)$.
%   \end{enumerate}
% \end{proof}

За да докажем, че $\val{\tau} \triangleleft_{\vv{nat}} \tau$, то трябва да докажем, че за всеки тип $\vv{a}$ и всеки затворен терм $\tau$ от тип $\vv{a}$, че е изпълнено
$\val{\tau} \triangleleft_{\vv{a}} \tau$ с индукция по построението на термовете.
Тук обаче имаме проблем. Ако $\tau \equiv \lamb{y}{b}{\tau_1}$, то трябва да използваме индукционно предположение за $\tau_1$,
в който вече има свободна променлива $\vv{y}$. Поради тази причина, ние трябва да разгледаме едно по-общо твърдение, при което позволяваме в термовете да се срещат свободни променливи.

\begin{framed}
  \begin{lemma}[Фундаментално свойство на $\triangleleft_{\vv{a}}$]\label{lem:pcf:fundamental}
    Нека $\Gamma = \vv{x}_1:\vv{a}_1,\dots,\vv{x}_n:\vv{a}_n$. Тогава
    \begin{prooftree}
      \AxiomC{$\Gamma \vdash \tau : \vv{a}$}
      \AxiomC{$(u_1,\dots,u_n) \triangleleft_\Gamma (\mu_1,\dots,\mu_n)$}
      \BinaryInfC{$\val{\tau}_\Gamma(\ov{u}) \triangleleft_{\vv{a}} \tau[\ov{\vv{x}}/\ov{\mu}]$}
    \end{prooftree}
  \end{lemma}  
\end{framed}
\begin{proof}
  Индукция по построението на термовете.
  \begin{itemize}
  \item
    Нека $\tau \equiv \vv{n}$. Тук директно от дефиницията на релацията $\triangleleft_{\vv{nat}}$ имаме, че
    \[n \triangleleft_{\vv{nat}} \vv{n}.\]
  \item
    \marginpar{Понеже $\Gamma \vdash \tau : \vv{a}$, то няма как $\tau$ да е променлива, която да не е някоя измежду $\vv{x}_1,\dots,\vv{x}_n$.}
    Нека $\tau \equiv \vv{x}_i$. Този случай също е много лесен.
    Имаме, че $\tau[\ov{x}/\ov{\mu}] \equiv \mu_i$ и $\val{\tau}_\Gamma(\ov{u}) = u_i$.
    Тогава, понеже $(u_1,\dots,u_n) \triangleleft_\Gamma (\mu_1,\dots,\mu_n)$,
    то директно получаваме, че
    \[\val{\tau}_\Gamma(\ov{u}) \triangleleft_{\vv{a}} \tau[\ov{x}/\ov{\mu}].\]
  \item
    Нека $\tau \equiv \tau_1 + \tau_2$. Тогава от правилата за типизиране имаме, че $\vv{a} = \vv{nat}$. Имаме също, че
    \begin{align*}
      & \tau[\ov{x}/\ov{\mu}] \equiv \tau_1[\ov{x}/\ov{\mu}] + \tau_2[\ov{x}/\ov{\mu}];\\
      & \val{\tau}_\Gamma(\ov{u}) = \plus(\underbrace{\val{\tau_1}_\Gamma(\ov{u})}_{n_1},\underbrace{\val{\tau_2}_\Gamma(\ov{u})}_{n_2}) = n.
    \end{align*}
    Можем да приемем, че $n \neq \bot$, защото иначе този случай е тривиален заради дефиницията на $\triangleleft_{\vv{nat}}$.
    От \IndHyp имаме, че $\val{\tau_1}_\Gamma(\ov{u}) \triangleleft_{\vv{nat}} \tau_1[\ov{x}/\ov{\mu}]$
    и $\val{\tau_2}_\Gamma(\ov{u}) \triangleleft_{\vv{nat}} \tau_2[\ov{x}/\ov{\mu}]$.
    Това означава, че $\tau_1[\ov{x}/\ov{\mu}] \Downarrow_{\vv{nat}} \vv{n}_1$ и $\tau_2[\ov{x}/\ov{\mu}] \Downarrow_{\vv{nat}}
    \vv{n}_2$.
    От правилата на операционната семантика е ясно, че $\tau[\ov{x}/\ov{\mu}] \Downarrow_{\vv{nat}} \vv{n}$ и следователно
    \[\val{\tau}_\Gamma(\ov{u}) \triangleleft_{\nat} \tau[\ov{\vv{x}}/\ov{\mu}].\]
  \item
    Нека $\tau \equiv \tau_1\ \vv{-}\ \tau_2$. 
  \item
    Нека $\tau \equiv \tau_1\ \vv{==}\ \tau_2$. 
  \item
    Нека $\tau \equiv \ifelse{\tau_1}{\tau_2}{\tau_3}$.
    От правилата за типизиране имаме, че $\Gamma \vdash \tau_1 : \nat$ и
    $\Gamma \vdash \tau_2 : \vv{a}$ и $\Gamma \vdash \tau_3 : \vv{a}$.
    Знаем също, че
    \begin{align*}
      & \tau[\ov{x}/\ov{\mu}] \equiv \ifelse{\tau_1[\ov{x}/\ov{\mu}]}{\tau_2[\ov{x}/\ov{\mu}]}{\tau_3[\ov{x}/\ov{\mu}]}\\
      & \val{\tau}_\Gamma(\ov{u}) = \texttt{if}(\val{\tau_1}_\Gamma(\ov{u}),\val{\tau_2}_\Gamma(\ov{u}),\val{\tau_3}_\Gamma(\ov{u})).
    \end{align*}

    Случаят, когато $\val{\tau_1}_\Gamma(\ov{u}) = \bot^{\val{\nat}}$ е очевиден и ще го пропуснем.
    \marginpar{Случаят, когато $\val{\tau_1}_\Gamma(\ov{u}) > 0$ е сходен и ще го оставим за трудолюбивия читател.}
    Нека да разгледаме случая, когато $\val{\tau_1}_\Gamma(\ov{u}) = 0$.
    Тогава $\val{\tau}_\Gamma(\ov{u}) = \val{\tau_3}_\Gamma(\ov{u})$.
    От \IndHyp за $\tau_1$ получаваме, че
    \[\val{\tau_1}_\Gamma(\ov{u}) \triangleleft_{\nat} \tau_1[\ov{x}/\ov{\mu}].\]
    От дефиницията на $\triangleleft_{\nat}$ следва, че щом $\val{\tau_1}_\Gamma(\ov{u}) = 0$, то $\tau_1[\ov{x}/\ov{\mu}] \Downarrow_{\nat} \vv{0}$.
    От \IndHyp за $\tau_3$ получаваме, че
    \[\underbrace{\val{\tau_3}_\Gamma(\ov{u})}_{\val{\tau}_\Gamma(\ov{u})} \triangleleft_{\vv{a}} \tau_3[\ov{x}/\ov{\mu}].\]
    Сега от правилата на операционната семантика имаме, че
    \begin{prooftree}
      \AxiomC{$\tau_1[\ov{x}/\ov{\mu}] \opsem{}{nat} \vv{0}$}
      \AxiomC{$\tau_3[\ov{x}/\ov{\mu}] \opsem{}{a} \vv{v}$}
      \RightLabel{\scriptsize{(if$_0$})}
      \BinaryInfC{$\underbrace{\ifelse{\tau_1[\ov{x}/\ov{\mu}]}{\tau_2[\ov{x}/\ov{\mu}]}{\tau_3[\ov{x}/\ov{\mu}]}}_{\tau[\ov{x}/\ov{\mu}]} \opsem{}{a} \vv{v}$}
    \end{prooftree}
    Да напишем на чисто важните неща, които имаме до момента.
    \begin{itemize}
    \item
      $\val{\tau}_\Gamma(\ov{u}) \triangleleft_{\vv{a}} \tau_3[\ov{x}/\ov{\mu}]$;
    \item
      $(\forall \vv{v})[\tau_3[\ov{x}/\ov{\mu}] \opsem{}{a} \vv{v} \implies \tau[\ov{x}/\ov{\mu}] \opsem{}{a} \vv{v}]$.
    \end{itemize}
    Сега директно прилагаме \Prop{pcf:adequacy:implication} и получаваме, че $\val{\tau}_\Gamma(\ov{u}) \triangleleft_{\vv{a}} \tau[\ov{x}/\ov{\mu}]$.
  \item
    Нека $\tau \equiv \tau_1\tau_2$. От правилата за типизиране имаме, че
    \begin{prooftree}
      \AxiomC{$\Gamma \vdash \tau_1 : \vv{b} \to \vv{a}$}
      \AxiomC{$\Gamma \vdash \tau_2 : \vv{b}$}
      \BinaryInfC{$\Gamma \vdash \tau_1\tau_2 : \vv{a}$}
    \end{prooftree}
    Да напомним, че
    \[\val{\tau_1\tau_2}_\Gamma(\ov{u}) \df \texttt{eval}(\val{\tau_1}_\Gamma(\ov{u}), \val{\tau_2}_\Gamma(\ov{u})).\]
    Понеже $\tau$ е съставен от $\tau_1$ и $\tau_2$, от \IndHyp имаме следното:
    \begin{align*}
      & \val{\tau_1}_\Gamma(\ov{u}) \triangleleft_{\vv{b}\to\vv{a}} \tau_1[\ov{x}/\ov{\mu}];\\
      & \val{\tau_2}_\Gamma(\ov{u}) \triangleleft_{\vv{b}} \tau_2[\ov{x}/\ov{\mu}].
    \end{align*}
    Щом $\val{\tau_1}_\Gamma(\ov{u}) \triangleleft_{\vv{b}\to\vv{a}} \tau_1[\ov{x}/\ov{\mu}]$, то
    от дефиницията на релацията $\triangleleft_{\vv{b}\to\vv{a}}$ следва, че за произволни $e \triangleleft_{\vv{b}} \rho$ имаме, че
    $\texttt{eval}(\val{\tau_1}_\Gamma(\ov{u}),e) \triangleleft_{\vv{a}} \tau_1[\ov{x}/\ov{\mu}](\rho)$. Нека сега да вземем $e \df \val{\tau_2}_\Gamma(\ov{u})$ и $\rho \df  \tau_2[\ov{x}/\ov{\mu}]$.
    Така получаваме  
    \[\underbrace{\texttt{eval}(\val{\tau_1}_\Gamma(\ov{u}), \val{\tau_2}_\Gamma(\ov{u}))}_{\val{\tau}_\Gamma(\ov{u})} \triangleleft_{\vv{a}} \underbrace{\tau_1[\ov{x}/\ov{\mu}](\tau_2[\ov{x}/\ov{\mu}])}_{\tau[\ov{x}/\ov{\mu}]}.\]
  \item
    Нека $\tau = \lamb{y}{b}{\tau'}$. Тогава от правилата за типизиране следва, че $\vv{a} = \vv{b} \to \vv{c}$, за някои типове $\vv{b}$ и $\vv{c}$, и
    $\Gamma,\type{y}{b} \vdash \tau' : \vv{c}$.
    Да напомним, че
    \[\val{\tau}_\Gamma(\ov{u}) \df \texttt{curry}(\val{\tau'}_{\Gamma,\type{y}{b}})(\ov{u}) \in \Cont{\val{\vv{b}}}{\val{\vv{c}}}.\]
    Да положим $f \df \val{\tau}_\Gamma(\ov{u})$. Тогава лесно се съобразява, че:
    \begin{align*}
      f(e) & = \val{\tau}_\Gamma(\ov{u})(e) \\
           & = \texttt{curry}(\val{\tau'}_{\Gamma,\type{y}{b}})(\ov{u})(e)\\
           & = \val{\tau'}_{\Gamma,\type{y}{b}}(\ov{u},e).
    \end{align*}
    Трябва да докажем, че $f \triangleleft_{\vv{b} \to \vv{c}} \tau[\ov{x}/\ov{\mu}]$.
    Това означава, че за произволни $e \in \val{\vv{b}}$ и $\rho : \vv{b}$, за които $e \triangleleft_{\vv{b}} \rho$,
    трябва да докажем, че $f(e) \triangleleft_{\vv{c}} \tau[\ov{x}/\ov{\mu}](\rho)$.

    Имаме, че
    \begin{prooftree}
      \AxiomC{$\Gamma,\type{y}{b} \vdash \tau' : \vv{c}$}
      \AxiomC{$(u_1,\dots,u_n,e) \triangleleft_{\Gamma,\type{y}{b}} (\mu_1,\dots,\mu_n,\rho)$}
      \RightLabel{\scriptsize{\IndHyp}}
      \BinaryInfC{$\underbrace{\val{\tau'}_{\Gamma,\type{y}{b}}(\ov{u},e)}_{f(e)} \triangleleft_{\vv{c}} \tau'[\ov{x}/\ov{\mu}][y/\rho]$}
    \end{prooftree}
    От правилата на операционната семантика имаме следното:
    \begin{prooftree}
      \AxiomC{$\lamb{y}{b}{\tau'[\ov{x}/\ov{\mu}]}$ е стойност}
      \UnaryInfC{$\lamb{y}{b}{\tau'[\ov{x}/\ov{\mu}]} \Downarrow_{\vv{b}\to\vv{c}} \lamb{y}{b}{\tau'[\ov{x}/\ov{\mu}]} $}
      \AxiomC{$\tau'[\ov{x}/\ov{\mu}][y/\rho] \Downarrow_{\vv{c}} \vv{v}$}
      \RightLabel{\scriptsize{(cbn)}}
      \BinaryInfC{$(\underbrace{\lamb{y}{b}{\tau'[\ov{x}/\ov{\mu}]}}_{\tau[\ov{x}/\ov{\mu}]})(\rho) \Downarrow_{\vv{c}} \vv{v}$}
    \end{prooftree}
    Да обобщим какво имаме до момента:
    \begin{itemize}
    \item
      $f(e) \triangleleft_{\vv{c}} \tau'[\ov{x}/\ov{\mu}][y/\rho]$;
    \item
      $(\forall \vv{v})[\ \tau'[\ov{x}/\ov{\mu}][y/\rho] \opsem{}{c} \vv{v} \implies \tau[\ov{x}/\ov{\mu}] \opsem{}{c} \vv{v}\ ]$.
    \end{itemize}
    От \Prop{pcf:adequacy:implication} веднага заключаваме, че $f(e) \triangleleft_{\vv{c}} \tau[\ov{x}/\ov{\mu}](\rho)$, което трябваше да докажем.
  \item
    Нека $\tau \equiv \fix(\tau')$.
    Тук трябва да докажем, че $\val{\fix(\tau')}(\ov{u}) \triangleleft_{\vv{a}} \tau[\ov{x}/\ov{\mu}]$.
    От правилата за типизиране имаме, че $\Gamma \vdash \tau' : \vv{a} \to \vv{a}$.
    От \IndHyp, приложено за $\tau'$, имаме, че
    \[\val{\tau'}_\Gamma(\ov{u}) \triangleleft_{\vv{a}\to\vv{a}} \tau'[\ov{x}/\ov{\mu}].\]
    Нека за улеснение да положим $f \df \val{\tau'}_\Gamma(\ov{u}) \in \Cont{\val{\vv{a}}}{\val{\vv{a}}}$.
    Да напомним, че
    \[\val{\fix(\tau')}_\Gamma(\ov{u}) = \lfp(f).\]
    От \Prop{pcf:adequacy:chain} знаем, че за всяка верига $\chain{d}{i}$ от елементи на
    \[D \df \{d \in \val{\vv{a}} \mid d \triangleleft_{\vv{a}} \fix(\tau'[\ov{x}/\ov{\mu}])\}\]
    е изпълнено, че $\bigsqcup_i d_i \in D$. Целта ни е да докажем, че
    $\lfp(f) \in D$. Да напомним, че $\lfp(f) = \bigsqcup_n f^n(\bot^{\val{\vv{a}}})$.
    С индукция по $n$ ще докажем, че за всяко $n$, $f^n(\bot^{\val{\vv{a}}}) \in D$.

    За $n = 0$ е ясно, понеже от \Prop{pcf:adequacy:bottom} имаме, че $f^0(\bot^{\val{\vv{a}}}) = \bot^{\val{\vv{a}}} \in D$.

    Нека сега $n > 0$. Ще използваме, че от \IndHyp имаме, че $f^{n-1}(\bot^{\val{\vv{a}}}) \in D$.
    Понеже $f \triangleleft_{\vv{a}\to\vv{a}} \tau'[\ov{x}/\ov{\mu}]$, то
    за произволно $e \triangleleft_{\vv{a}} \rho$ е изпълнено, че
    $f(e) \triangleleft_{\vv{a}} \tau'[\ov{x}/\ov{\mu}](\rho)$.
    Нека изберем $\rho \df \fix(\tau'[\ov{x}/\ov{\mu}])$ и $e \df f^{n-1}(\bot^{\val{\vv{a}}})$.
    Щом $f^{n-1}(\bot^{\val{\vv{a}}}) \in D$, то $f^{n-1}(\bot^{\val{\vv{a}}}) \triangleleft_{\vv{a}} \rho$ и следователно
    \[f(f^{n-1}(\bot^{\val{\vv{a}}})) \triangleleft_{\vv{a}} \tau'[\ov{x}/\ov{\mu}](\underbrace{\fix(\tau'[\ov{x}/\ov{\mu}])}_{\rho}).\]
    От правилата на операционната семантика имаме, че:
    \begin{prooftree}
      \AxiomC{$\tau'[\ov{x}/\ov{\mu}](\fix(\tau'[\ov{x}/\ov{\mu}])) \Downarrow_{\vv{a}} \vv{v}$}
      \RightLabel{\scriptsize{(fix)}}
      \UnaryInfC{$\fix(\tau'[\ov{x}/\ov{\mu}]) \Downarrow_{\vv{a}} \vv{v}$}
    \end{prooftree}
    Тогава от \Prop{pcf:adequacy:implication} следва, че
    \[f(f^{n-1}(\bot^{\val{\vv{a}}})) \triangleleft_{\vv{a}} \fix(\tau'[\ov{x}/\ov{\mu}]).\]
    Така доказахме, че $f^n(\bot^{\val{\vv{a}}}) \in D$.
    Заключаваме, че $\lfp(f) \in D$, т.е.
    \[\val{\fix(\tau')}_\Gamma(\ov{u}) \triangleleft_{\vv{a}} \fix(\tau'[\ov{x}/\ov{\mu}])\]
  \end{itemize}
\end{proof}

\begin{corollary}\label{cr:pcf:fundamental}
  За всеки тип $\vv{a}$ и за всеки затворен терм $\tau$ е изпълнено свойството:
  \[\tau \in \text{PCF}_{\vv{a}} \implies \val{\tau} \triangleleft_{\vv{a}} \tau.\]
\end{corollary}

Така на практика доказахме теоремата за адекватност.

\begin{framed}
  \begin{theorem}[Теорема за адекватност]\label{th:pcf:adequacy}
    За всеки затворен терм $\tau : \vv{nat}$, 
    \[\val{\tau} = n \neq \bot^{\val{\nat}} \implies \tau \Downarrow_{\vv{nat}} \vv{n}.\]
  \end{theorem}
\end{framed}
\begin{proof}
  Да разгледаме произволен затворен терм $\tau : \vv{nat}$.
  Нека $\val{\tau} = n \neq \bot$.
  От \Cor{pcf:fundamental} имаме, че $\val{\tau} \triangleleft_{\vv{nat}} \tau$.
  Тогава от дефиницията на $\triangleleft_{\vv{nat}}$ получаваме, че $\tau \Downarrow_{\vv{nat}} \vv{n}$.
\end{proof}

\begin{framed}
  \begin{corollary}
    За всеки затворен терм $\tau : \vv{nat}$, 
    \[\val{\tau} = n \neq \bot^{\val{\nat}} \text{ точно тогава, когато } \tau \Downarrow_{\vv{nat}} \vv{n}.\]
  \end{corollary}
\end{framed}
\begin{proof}
  Посоката $(\Rightarrow)$ е \hyperref[th:pcf:adequacy]{теоремата за адекватност}.
  Посоката $(\Leftarrow)$ е \hyperref[th:pcf:soundness]{теоремата за коректност}.
\end{proof}


Да разгледаме термовете
\begin{align*}
  & \tau \equiv \lamb{x}{nat}{\vv{x + 0}}\\
  & \rho \equiv \lamb{x}{nat}{\vv{x}}.
\end{align*}


Ясно е, че $\val{\tau} = \val{\rho}$, но според правилата на операционната семантика, понеже $\tau$ е стойност, то
$\tau \not\Downarrow_{\vv{nat}\to\vv{nat}} \rho$.
Оттук веднага е ясно, че няма как да имаме теорема за адекватност за по-високи типове от $\vv{nat}$.


% \begin{corollary}
%   За всеки $\tau \in \text{PCF}_{\nat}$ е изпълнена импликацията:
%   \[\tau \not\Downarrow_{\nat}\ \implies\ \val{\tau} = \bot^{\val{\nat}}.\]  
% \end{corollary}
% \begin{proof}

% \end{proof}

Следващото следствие ни казва, че за типа $\nat$, $\bot$ означава изчисление, което никога не завършва.

\begin{framed}
  \begin{corollary}
    Нека $\tau$ е затворен терм от тип $\nat$. Тогава 
    \[\val{\tau} = \bot^{\val{\nat}} \text{ точно тогава, когато } \tau \not\opsem{}{nat}.\]
  \end{corollary}
\end{framed}
% \begin{proof}
%   Първо, да допуснем, че $\val{\tau} = \bot^{\val{\nat}}$, но $\tau \opsem{}{nat} \vv{n}$, за някоя константа $\vv{n}$. Тогава от \hyperref[th:pcf:soundness]{теоремата за коректност} получаваме, че $\val{\tau} = n \neq \bot^{\val{\nat}}$, което е противоречие.
  
%   Второ, да допуснем, че $\tau \not\Downarrow_{\nat}$, но $\val{\tau} = n \neq \bot$.
%   Но тогава от \hyperref[th:pcf:adequacy]{теоремата за адекватност} следва, че $\tau \Downarrow_{\nat} \vv{n}$, което е противоречие.
% \end{proof}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "../sep"
%%% End:
