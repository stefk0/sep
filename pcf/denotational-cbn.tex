\section{Денотационна семантика с предаване на параметрите по име}

Семантиката на всеки тип ще бъде област на Скот както следва:
\begin{align*}
  & \val{\vv{nat}} \df \Nat_\bot\\
  & \val{\vv{a} \to \vv{b}} \df \Cont{\val{\vv{a}}}{\val{\vv{b}}}.
\end{align*}
\marginpar{Да напомним, че \[\emptyset_\bot = (\{\bot\},\sqsubseteq,\bot).\]}
\marginpar{От Раздел~\ref{subsect:domains:product} знаем, че $\val{\Gamma}$ е област на Скот.}
За един типов контекст $\Gamma$, дефинираме $\val{\Gamma}$ по следния начин:
\begin{itemize}
\item
  Ако $\Gamma = \emptyset$, то $\val{\Gamma} = \emptyset_\bot$;
\item
  Ако $\Gamma = \Gamma', \vv{x:a}$, то $\val{\Gamma} = \val{\Gamma'} \times \val{\vv{a}}$.
\end{itemize}
Например, ако $\Gamma = \vv{x}_1 : \vv{a}_1,\ \vv{x}_2 : \vv{a}_2,\ \vv{x}_3 : \vv{a}_3$, то
\[\val{\Gamma} = (\val{\vv{a}_1} \times \val{\vv{a}_2})\times \val{\vv{a}_3}.\]

Сега трябва да дефинираме семантика на термовете.
За всеки терм, за който $\fv(\tau) \subseteq \texttt{dom}(\Gamma)$ и
за произволни $\overline{u} \in \val{\Gamma}$, дефинираме неговата стойност $\val{\tau}_\Gamma(\overline{u})$ по следния начин:
\begin{itemize}
\item
  Нека $\tau \equiv \vv{n}$. Тогава
  \[\val{\vv{n}}_\Gamma(\overline{u}) \df n.\]
\item
  Нека $\tau \equiv \vv{x}_i$. Тогава
  \[\val{\vv{x}_i}_\Gamma(\overline{u}) \df u_i.\]
\item
  \marginpar{За $\texttt{plus}$ вижте Раздел~\ref{subsect:rec:term-value}.}
  Нека $\tau \equiv \tau_1 + \tau_2$. Тогава
  \[\val{\tau_1 + \tau_2}_\Gamma(\overline{u}) \df \texttt{plus}(\val{\tau_1}_\Gamma(\overline{u}), \val{\tau_2}_\Gamma(\overline{u})).\]
\item
  \marginpar{За $\texttt{eq}$ вижте Раздел~\ref{subsect:rec:term-value}.}
  Нека $\tau \equiv \tau_1\ \vv{==}\ \tau_2$. Тогава
  \[\val{\tau_1\ \vv{==}\ \tau_2}_\Gamma(\overline{u}) \df \texttt{eq}(\val{\tau_1}_\Gamma(\overline{u}), \val{\tau_2}_\Gamma(\overline{u})).\]
\item
  \marginpar{За $\texttt{if}$ вижте \Def{if}.}
  Нека $\tau \equiv \ifelse{\tau_1}{\tau_2}{\tau_3}$. Тогава
  \[\val{\ifelse{\tau_1}{\tau_2}{\tau_3}}_\Gamma(\overline{u}) \df \texttt{if}(\val{\tau_1}_\Gamma(\overline{u}),
  \val{\tau_2}_\Gamma(\overline{u}), \val{\tau_3}_\Gamma(\overline{u})).\]
\item
  \marginpar{За $\texttt{eval}$ вижте \Def{eval}.}
  Нека $\tau \equiv \tau_1 \tau_2$. Тогава
  \[\val{\tau_1 \tau_2}_\Gamma(\overline{u}) \df \texttt{eval}(\val{\tau_1}_\Gamma(\overline{u}), \val{\tau_2}_\Gamma(\overline{u})).\]
\item
  \marginpar{За $\lfp$ вижте Раздел~\ref{sect:lfp}.}
  Нека $\tau \equiv \fix(\tau')$. Тогава 
  \[\val{\fix(\tau')}_\Gamma(\overline{u}) \df \lfp(\val{\tau'}_\Gamma(\overline{u})).\]
\item
  \marginpar{За $\curry$ вижте \Def{curry}.}
  Нека $\tau \equiv \lamb{y}{b}{\tau'}$, като $\vv{y} \not \in \texttt{dom}(\Gamma)$.
  Нека $\Gamma' \df \Gamma, \type{y}{b}$. Тогава
  \[\val{\lamb{y}{b}{\tau'}}_\Gamma(\overline{u}) \df \curry(\val{\tau'}_{\Gamma'})(\overline{u}).\]
\end{itemize}

\begin{remark}
  За $\Gamma = \emptyset$, ще пишем $\val{\tau}$ вместо $\val{\tau}_\emptyset$.
\end{remark}

Не е ясно дали винаги горните дефиниции имат смисъл.
Сега ще докажем, че винаги, когато един терм е добре типизиран, то горната дефиниция има смисъл.

\begin{framed}
  \begin{lemma}
    Ако $\Gamma \vdash \tau : \vv{a}$, то $\val{\tau}_\Gamma \in \Cont{\val{\Gamma}}{\val{\vv{a}}}$.
  \end{lemma}  
\end{framed}
\begin{proof}
  Доказателството протича с индукция по построението на термовете
  като съществено използваме \Prop{composition} според което, ако $f \in \Cont{\A}{\B}$ и $g \in \Cont{\B}{\C}$, то
  $g \circ f \in \Cont{\A}{\C}$.
  \marginpar{Изображението $f \times g$ е дефинирано в \Prop{cartesian-continuous}.}
  \begin{itemize}
  \item
    Нека $\tau \equiv \vv{n}$. Щом $\Gamma \vdash \tau : \vv{a}$, то
    по правилата за типизиране следва, че $\vv{a} = \vv{nat}$.
    Сега лесно се съобразява, че изображението $\val{\vv{n}}_\Gamma \in \Cont{\val{\Gamma}}{\val{\vv{nat}}}$, където
    $\val{\vv{n}}_\Gamma(\overline{u}) = n$.
    Това е така, защото за всяка верига $\chain{\overline{u}}{i}$ от елементи на $\val{\Gamma}$,
    \[\val{\vv{n}}_\Gamma(\bigsqcup_i\overline{u}_i) = n = \bigsqcup_i\{ \val{\vv{n}}(\overline{u}_i)\}.\]
  \item
    Нека $\tau \equiv \vv{x}_i$. Щом $\Gamma \vdash \tau : \vv{a}$, то
    по правилата за типизиране следва, че $\vv{a} = \vv{a}_i$.
    Сега лесно се съобразява, че изображението $\val{\vv{n}}_\Gamma \in \Cont{\val{\Gamma}}{\val{\vv{a}_i}}$, където
    $\val{\vv{n}}_\Gamma(\overline{u}) = u_i$.
    \marginpar{$\overline{u}_k = (u_{1,k},\dots,u_{n,k})$.}
    Това е така, защото за всяка верига $\chain{\overline{u}}{n}$ от елементи на $\val{\Gamma}$,
    \[\val{\vv{x}_i}_\Gamma(\bigsqcup_n\overline{u}_n) = \bigsqcup_n u_{i,n} = \bigsqcup_i\{ \val{\vv{x}_i}(\overline{u}_n)\}.\]
  \item
    Нека $\tau \equiv \tau_1 + \tau_2$. Щом $\Gamma \vdash \tau : \vv{a}$, то
    по правилата за типизиране следва, че $\vv{a} = \vv{nat}$, а също и $\Gamma \vdash \tau_1 : \vv{nat}$ и $\Gamma \vdash \tau_2
    : \vv{nat}$.
    От И.П. имаме, че
    \begin{align*}
      & \val{\tau_1}_\Gamma \in \Cont{\val{\Gamma}}{\val{\vv{nat}}};\\
        & \val{\tau_2}_\Gamma \in \Cont{\val{\Gamma}}{\val{\vv{nat}}}.
    \end{align*}
    Това означава, че $(\val{\tau_1} \times \val{\tau_2}) \in \Cont{\val{\Gamma}}{\val{\vv{nat}} \times \val{\vv{nat}}}$.
    Тогава имаме следното равенство
    \marginpar{Използваме, че композиция на непрекъснати изображения е непрекъснато изображение.}
    \[\val{\tau_1 + \tau_2}_\Gamma = \texttt{plus} \circ (\val{\tau_1} \times \val{\tau_2}) \in \Cont{\val{\Gamma}}{\val{\vv{a}}},\]
    защото за произволни $\overline{u} \in \val{\Gamma}$,
    \begin{align*}
      (\texttt{plus} \circ (\val{\tau_1} \times \val{\tau_2}))(\overline{u}) & = \texttt{plus}((\val{\tau_1} \times \val{\tau_2})(\overline{u}))\\ 
                                                                             & = \texttt{plus}(\val{\tau_1}_\Gamma(\overline{u}), \val{\tau_2}_\Gamma(\overline{u}))\\
                                                                             & \df \val{\tau}_\Gamma(\overline{u}).
    \end{align*}
  \item
    Нека $\tau \equiv \tau_1\ \vv{==}\ \tau_2$. Съобразете сами, че 
    \[\val{\tau_1\ \vv{==}\ \tau_2}_\Gamma = \texttt{eq} \circ (\val{\tau_1}_\Gamma \times \val{\tau_2}_\Gamma) \in \Cont{\val{\Gamma}}{\val{\vv{a}}}.\]
  \item
    Нека $\tau \equiv \ifelse{\tau_1}{\tau_2}{\tau_3}$. Съобразете сами, че 
    \[\val{\ifelse{\tau_1}{\tau_2}{\tau_3}}_\Gamma = \texttt{if} \circ (\val{\tau_1}_\Gamma \times \val{\tau_2}_\Gamma \times \val{\tau_3}_\Gamma)  \in \Cont{\val{\Gamma}}{\val{\vv{a}}}.\]
  \item
    Нека $\tau \equiv \tau_1 \tau_2$.
    Щом $\Gamma \vdash \tau_1 \tau_2 : \vv{a}$, то от правилата за типизиране следва, че
    \begin{align*}
      & \Gamma \vdash \tau_1 : \vv{b} \to \vv{a}\\
      & \Gamma \vdash \tau_2 : \vv{b}.
    \end{align*}
    От И.П. за $\tau_1$ и $\tau_2$ знаем, че
    \begin{align*}
      & \val{\tau_1}_\Gamma \in \Cont{\val{\Gamma}}{\Cont{\val{\vv{b}}}{\val{\vv{a}}}} \\
      & \val{\tau_2}_\Gamma \in \Cont{\val{\Gamma}}{\val{\vv{b}}}
    \end{align*}
    Оттук получаваме, че за произволни $\overline{u} \in \val{\Gamma}$,
    \begin{align*}
      & \val{\tau_1}_\Gamma(\overline{u}) \in \Cont{\val{\vv{b}}}{\val{\vv{a}}} \\
      & \val{\tau_2}_\Gamma(\overline{u}) \in \val{\vv{b}}.
    \end{align*}
    Тогава 
    \[\val{\tau_1 \tau_2}_\Gamma = \texttt{eval} \circ (\val{\tau_1}_\Gamma \times \val{\tau_2}_\Gamma) \in \Cont{\val{\Gamma}}{\val{\vv{a}}},\]
    защото за произволни $\overline{u} \in \val{\Gamma}$,
    \begin{align*}
      (\texttt{eval} \circ \val{\tau_1}_\Gamma \times \val{\tau_2}_\Gamma)(\overline{u}) & = \texttt{eval}((\val{\tau_1}_\Gamma \times \val{\tau_2}_\Gamma)(\overline{u}))\\
                                                                                         & = \texttt{eval}(\val{\tau_1}_\Gamma(\overline{u}), \val{\tau_2}_\Gamma(\overline{u}))\\
                                                                                         & \df \val{\tau_1\tau_2}_\Gamma(\overline{u}).
    \end{align*}
    
  \item
    Нека сега $\tau \equiv \fix(\tau')$.
    Понеже $\Gamma \vdash \fix(\tau') : \vv{a}$, то от правилата за типизиране имаме, че
    $\Gamma \vdash \tau' : \vv{a} \to \vv{a}$.
    От И.П. знаем, че
    \[\val{\tau'}_\Gamma \in \Cont{\val{\Gamma}}{\Cont{\val{\vv{a}}}{\val{\vv{a}}}}.\]
    Това означава, че за произволни $\overline{u} \in \val{\Gamma}$,
    \[\val{\tau'}_\Gamma(\overline{u}) \in \Cont{\val{\vv{a}}}{\val{\vv{a}}}.\]
    Следователно
    $\val{\tau'}_\Gamma(\overline{u})$ е изображение, което според \Th{knaster-tarski}
    притежава най-малка неподвижна точка.
    \marginpar{Непрекъснатото изображението $Y$ е дефинирано \Th{Y}.}
    Тогава
    \[\val{\texttt{fix}(\tau')}_\Gamma = Y \circ \val{\tau'}_\Gamma \in \Cont{\val{\Gamma}}{\val{\vv{a}}},\]
    защото за произволни $\overline{u} \in \val{\Gamma}$,
    \begin{align*}
      (Y \circ \val{\tau'}_\Gamma)(\overline{u}) & = Y(\val{\tau'}_\Gamma(\overline{u}))\\
                                                 & = \lfp(\val{\tau'}_\Gamma(\overline{u}))\\
                                                 & \df \val{\fix(\tau')}_\Gamma(\ov{u}).
    \end{align*}
  \item
    Нека $\tau \equiv \lamb{y}{b}{\tau'}$, като $\vv{y} \not \in \texttt{dom}(\Gamma)$.
    Щом $\Gamma \vdash \lamb{y}{b}{\tau'} : \vv{a}$, то от правилата за типизиране следва, че $\vv{a} = \vv{b} \to \vv{c}$
    и 
    \[\Gamma, \type{y}{b} \vdash \tau' : \vv{c}.\]
    
    Нека $\Gamma' = \Gamma, \vv{y}:\vv{b}$. Тогава $\val{\Gamma'} = \val{\Gamma} \times \val{\vv{b}}$, а от И.П. имаме, че
    \[\val{\tau'}_{\Gamma'} \in \Cont{\val{\Gamma} \times \val{\vv{b}}}{\val{\vv{c}}}.\]
    Тогава от \Prop{curry} следва, че
    \[\val{\lamb{y}{b}{\tau}}_\Gamma \df \curry(\val{\tau'}_{\Gamma'}) \in \Cont{\val{\Gamma}}{\Cont{\val{\vv{b}}}{\val{\vv{c}}}}.\]
  \end{itemize}
\end{proof}

\begin{remark}
  В случая $\Gamma = \emptyset$, формално погледнато,
  $\val{\tau}_\emptyset \in \Cont{\emptyset_\bot}{\A}$, за някоя област на Скот $\A$.
  Но ние знаем, че $\Cont{\emptyset_\bot}{\A} \cong \A$.
  Следователно, можем да считаме, че $\val{\tau} \in \A$.
  В противен случай, трябва винаги да пишем $\val{\tau}(\bot)$ вместо $\val{\tau}$.
\end{remark}


\begin{proposition}
  \marginpar{Ясно е, че това твърдение се обобщава за произволна пермутация на индекстите $1,\dots,n$ \cite[стр. 106]{types-programming-languages}.}
  Нека имаме следните типови контексти:
  \begin{align*}
    &\Gamma = \vv{x}_1:\vv{a}_1, \dots, \vv{x}_i:\vv{a}_i, \dots, \vv{x}_j:\vv{a}_j, \dots, \vv{x}_n:\vv{a}_n;\\
    &\Delta = \vv{x}_1:\vv{a}_1, \dots, \vv{x}_j:\vv{a}_j, \dots, \vv{x}_i:\vv{a}_i, \dots, \vv{x}_n:\vv{a}_n,
  \end{align*}
  т.е. $\Delta$ се получава от $\Gamma$ като разменим местата на $i$-тата и $j$-тата двойка.
  Тогава за всеки терм $\tau$, такъв че $\Gamma \vdash \tau : \vv{a}$, е изпълено, че $\Delta \vdash \tau : \vv{a}$ и за всеки $(u_1,\dots,u_n) \in \val{\Gamma}$,
  \[\val{\tau}_\Gamma(u_1,\dots,u_i,\dots,u_j,\dots,u_n) = \val{\tau}_\Delta(u_1,\dots,u_j,\dots,u_i,\dots,u_n).\]
\end{proposition}
\begin{hint}
  Индукция по построението на терма $\tau$.
\end{hint}


%%% Local Variables:
%%% mode: latex
%%% TeX-master: "../sep"
%%% End:
