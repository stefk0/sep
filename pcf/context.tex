\section{Контексти}\label{pcf:sect:context}

\index{контекст}
\marginpar{\cite[Глава 6.1]{gunter}}
\marginpar{\cite[Глава 48]{practical-foundations}}
\marginpar{Интуитивно, контекстите са програмни фрагменти. Не са пълни програми, защото имат празни места означени с $-$.}
\[\C ::= -\ |\ \vv{n}\ |\ \vv{x}\ |\ \C + \C\ |\ \C\ \vv{==}\ \C\ |\ \ifelse{\C}{\C}{\C}\ |\ \C\C\ |\ \lamb{x}{a}{\C}\ |\ \fix(\C).\]
Контекстите са на практика изрази, като позволяваме да имат специална свободна променлива, която означаваме с $-$.
% За произволен израз $\tau$, с $\C\{\tau\}$ означаваме израза $\C\rename{-}{\tau}$, където считаме $-$ като свободна променлива на $\C$.
% Това означава, че заместваме всички срещания на $-$ с $\tau$ като правим заместването директно, т.е.
% не се интересуваме дали някоя свободна променлива на $\tau$ няма да попадне под обхвата на свързана променлива в $\C$.
% Например, ако $\C = \lamb{x}{a}{-}$, то $\C\rename{-}{\vv{x}} =
% \lamb{x}{a}{\vv{x}}$.
За краткост, вместо $\C\{-/\tau\}$ ще пишем $\C[\tau]$.

\begin{proposition}
  % \marginpar{Да напомним, че с $\equiv$ означаваме релацията $\alpha$-еквивалентност.}
  Ако $\tau \equiv_\alpha \tau'$, то $\C[\tau] \equiv_\alpha \C[\tau']$.
\end{proposition}
\begin{hint}
  Индукция по построението на контекстите.
\end{hint}

\marginpar{Някои наричат тази релация observational equivalence. Тук наричаме релацията contextual equivalence.}
\begin{definition}\label{df:context:equivalence}
  За затворени термове $\tau_1$ и $\tau_2$, дефинираме
  $\tau_1 \leq_{ctx} \tau_2 : \vv{a}$, ако
  \begin{enumerate}[1)]
  \item
    $\emptyset \vdash \tau_1 : \vv{a}$ и $\emptyset \vdash \tau_2 : \vv{a}$
  \item
    За \emph{всички} контексти $C[-]$, за които $\emptyset \vdash C[\tau_1] : \nat$ и $\emptyset \vdash C[\tau_2] : \nat$, то
    \[C[\tau_1] \Downarrow_{\nat} \vv{n} \implies C[\tau_2] \Downarrow_{\nat} \vv{n}.\]
  \end{enumerate}
  Ще пишем $\tau_1 \cong_{ctx} \tau_2 : \vv{a}$, ако
  $\tau_1 \leq_{ctx} \tau_2 : \vv{a}$ и $\tau_2 \leq_{ctx} \tau_1 : \vv{a}$.
\end{definition}


% \begin{itemize}
% \item 
  % Ще пишем $\tau_1 \cong_{ctx} \tau_2 : \vv{a}$, ако
  % $\tau_1 \leq_{ctx} \tau_2 : \vv{a}$ и $\Gamma \vdash \tau_2 \leq_{ctx} \tau_1 : \vv{a}$.
% \item
%   Ако $\Gamma = \emptyset$, то ще пишем $\tau_1 \cong_{ctx} \tau_2 : \vv{a}$ вместо $\emptyset \vdash \tau_1 \cong_{ctx} \tau_2 : \vv{a}$.  
% \end{itemize}

\marginpar{Two phrases of a programming language are contextually equivalent if any occurrences of the first phrase in a complete
  program can be replaced by the second phrase without affecting the observable results of executing the program.
  This kind of program equivalence is also known as operational, or observational equivalence.}

\begin{framed}
  Денотационната семантика $\val{.}$ се нарича {\bf напълно абстрактна}, ако денотационната и операционната наредба съвпадат, т.е. $\val{\tau_1} \sqsubseteq \val{\tau_2}$ точно тогава, когато
  $\tau_1 \leq_{ctx} \tau_2$.  Един от основните ранни резултати в изучаването на семантиката на езици за програмиране е, че нашата денотационна семантика не е напълно абстрактна.
\end{framed}

Практически, ако имаме два терма, които са контекстно еквивалентни, то можем да заменим единия с другия в произволна програма,
без да има видими разлики на ниво изпълнение на програмата.
% Това представлява опит да се формализира математически практиката за тестване на програми.
Проблемът е, че с този формализъм е трудно да се работи, защото в дефиницията имаме квантор
за всеобщност относно всички контексти (програмни фрагменти).

\begin{proposition}\label{pr:pcf:context:simple}
  За произволни затворени термове $\tau_1$ и $\tau_2$ е изпълнено, че:
  \begin{enumerate}[(1)]
  \item
    $\tau_1 \leq_{ctx} \tau_2 : \nat \implies (\forall \vv{n})[\tau_1\Downarrow_{\nat}\vv{n} \implies \tau_2 \Downarrow_{\nat} \vv{n}]$.
  \item
    $\tau_1 \leq_{ctx} \tau_2 : \vv{b}\to\vv{c} \implies (\forall \rho\in\text{PCF}_{\vv{b}})[\tau_1\rho \leq_{ctx} \tau_2 \rho : \vv{c}]$.
  \end{enumerate}
\end{proposition}
\begin{hint}
  \begin{enumerate}[(1)]
  \item
    Просто вземете контекст $\C \df -$. Ясно е, че $\C[\tau_i] \equiv \tau_i$.
  \item
    Да фиксираме произволен терм $\rho\in\text{PCF}_{\vv{b}}$.
    Да разгледаме произволен контекст $\C[-]$, за който $\C[\tau_1\rho]$ и $\C[\tau_2\rho]$
    са затворени термове от тип $\nat$.
    Разглеждаме контекста $\C' \df \C\rename{-}{(-\rho)}$,
    т.е. заменяме $-$ с $-\rho$ в контекста.
    Лесно се съобразява, че \[\C'[\tau_i] \equiv \C[\tau_i\rho].\]
    Понеже $\tau_1 \leq_{ctx} \tau_2 : \vv{b}\to\vv{c}$,
    то за контекста $\C'$ имаме, че
    \[\C'[\tau_1] \Downarrow_{\nat} \vv{n} \implies \C'[\tau_2] \Downarrow_{\nat} \vv{n}.\]
    Оттук веднага следва, че 
    \[\C[\tau_1\rho] \Downarrow_{\nat} \vv{n} \implies \C[\tau_2\rho] \Downarrow_{\nat} \vv{n}.\]
  \end{enumerate}
\end{hint}

\begin{proposition}\label{pr:pcf:context:terms}
  За произволни затворени термове $\tau_1$ и $\tau_2$ е изпълнено, че:
  \[\tau_1 \leq_{ctx} \tau_2 : \vv{a} \iff (\forall \rho \in \text{PCF}_{\vv{a}\to\nat})[\ \rho\tau_1 \Downarrow_{\nat} \vv{n} \implies \rho\tau_2 \Downarrow_{\nat} \vv{n}\ ].\]
\end{proposition}
\begin{hint}
  За $(\Rightarrow)$, при даден терм $\rho \in \text{PCF}_{\vv{a}\to\nat}$, просто вземете контекст $\C~=~\rho~-$.
  За $(\Leftarrow)$, нека имаме контекст $\C[-]$.
  Нека $\vv{z}$ е променлива, която не се среща в $\C[-]$.
  Разгледайте $\rho \df \lamb{z}{a}{\C\rename{-}{\vv{z}}}$.
  Тогава, понеже $\tau_i$ са затворени термове, то
  $\C\rename{-}{\tau_i} \equiv \rho\tau_i$.
\end{hint}

\begin{proposition}\label{pr:pcf:context:relation}
  За произволни затворени термове $\tau_1$ и $\tau_2$ от тип $\vv{a}$,
  \[(d \triangleleft_{\vv{a}} \tau_1\ \&\ \tau_1 \leq_{ctx} \tau_2 : \vv{a}) \implies d \triangleleft_{\vv{a}} \tau_2.\]
\end{proposition}
\begin{proof}
  Индукция по построението на типовете $\vv{a}$.
  Нека $\vv{a} = \nat$.
  Нека $d \neq \bot$, защото е ясно, че $\bot \triangleleft_{\nat} \tau_2$.
  Понеже $d \triangleleft_{\nat} \tau_1$, то $\tau_1 \Downarrow_{\nat} \vv{d}$.
  Понеже $\tau_1 \leq_{ctx} \tau_2 : \nat$, то $\tau_2 \Downarrow_{\nat} \vv{d}$.
  Заключаваме, че $d \triangleleft_{\nat} \tau_2$.
  
  Нека $\vv{a} = \vv{b} \to \vv{c}$.
  Нека $d \triangleleft_{\vv{b} \to \vv{c}} \tau_1$ и $\tau_1 \leq_{ctx} \tau_2 : \vv{b}\to\vv{c}$.
  Трябва да докажем, че $d \triangleleft_{\vv{b}\to\vv{c}} \tau_2$.
  Нека $u \in \val{\vv{b}}$ и $\rho \in \text{PCF}_{\vv{b}}$,
  за които $u \triangleleft_{\vv{b}} \rho$. Трябва да докажем, че $d(u) \triangleleft_{\vv{c}} \tau_2\rho$.
  От $d \triangleleft_{\vv{b} \to \vv{c}} \tau_1$ имаме, че $d(u) \triangleleft_{\vv{c}} \tau_1 \rho$.
  От (2) на \Prop{pcf:context:simple} имаме, че $\tau_1 \rho \leq_{ctx} \tau_2 \rho : \vv{c}$.
  От И.П. заключаваме, че $d(u) \triangleleft_{\vv{c}} \tau_2 \rho$.
\end{proof}

\begin{proposition}\label{pr:pcf:context:relation-characterization}
  За произволни затворени термове $\tau_1$ и $\tau_2$,
  \[\tau_1 \leq_{ctx} \tau_2 : \vv{a} \iff \val{\tau_1} \triangleleft_{\vv{a}} \tau_2.\]
\end{proposition}
\begin{proof}
  $(\Rightarrow)$ Нека $\tau_1 \leq_{ctx} \tau_2 : \vv{a}$.
  От \Prop{pcf:adequacy:implication} имаме, че
  \[\val{\tau_1} \triangleleft_{\vv{a}} \tau_1.\]
  Тогава от предишното твърдение директно следва, че $\val{\tau_1} \leq_{\vv{a}} \tau_2$.

  $(\Leftarrow)$ Нека сега $\val{\tau_1} \triangleleft_{\vv{a}} \tau_2$.
  Тук ще използваме характеризацията на $\leq_{ctx}$ от \Prop{pcf:context:terms}.
  Да разгледаме произволен терм $\rho \in \text{PCF}_{\vv{a} \to \nat}$.
  Отново \Prop{pcf:adequacy:implication} имаме, че $\val{\rho} \triangleleft_{\vv{a} \to \nat} \rho$.
  Тогава от дефиницията на релацията $\triangleleft_{\vv{a}\to\nat}$ следва, че:
  \[\val{\rho\tau_1} = \val{\rho}(\val{\tau_1}) \triangleleft_{\nat} \rho\tau_2.\]
  Тогава:
  \begin{align*}
    \rho\tau_1 \Downarrow_{\nat} \vv{n} & \implies \val{\rho\tau_1} = n & \comment\text{\hyperref[th:pcf:soundness]{Теорема за коректност}}\\
                                            & \implies \rho\tau_2 \Downarrow_{\nat} \vv{n}. & \comment\val{\rho\tau_1} \triangleleft_{\nat} \rho\tau_2
  \end{align*}
  Заключаваме, че $\tau_1 \leq_{ctx} \tau_2 : \vv{a}$.
\end{proof}

\begin{proposition}\label{pr:pcf:context:extensionality}
  За произволни затворени термове $\tau_1$ и $\tau_2$ е изпълнено, че:
  \begin{enumerate}[(1)]
  \item
    $\tau_1 \leq_{ctx} \tau_2 : \nat \iff (\forall \vv{n})[\tau_1 \Downarrow_{\nat} \vv{n} \implies \tau_2 \Downarrow_{\nat} \vv{n}]$;
  \item
    $\tau_1 \leq_{ctx} \tau_2 : \vv{a}\to\vv{b} \iff (\forall \rho \in \text{PCF}_{\vv{a}})[\ \tau_1\rho \leq_{ctx} \tau_2 \rho : \vv{b}\ ]$.
  \end{enumerate}
\end{proposition}
\begin{proof}
  \begin{enumerate}[(1)]
  \item
    Посоката $(\Rightarrow)$ следва директно от \Prop{pcf:context:simple}.
    За посоката $(\Leftarrow)$, понеже
    \begin{align*}
      \val{\tau_1} = \val{\vv{n}} & \implies \tau_1 \Downarrow_{\nat} \vv{n} & \comment\text{\hyperref[th:pcf:adequacy]{Теорема за адекватност}}\\
                                  & \implies \tau_2 \Downarrow_{\nat} \vv{n}, & \comment\text{от условието}
    \end{align*}
    то получаваме, че $\val{\tau_1} \triangleleft_{\nat} \tau_2$.
    Тогава от предишното твърдение директно имаме, че $\tau_1 \leq_{ctx} \tau_2 : \nat$.
  \item
    Посоката $(\Rightarrow)$ следва директно от дефиницията на $\leq_{ctx}$.
    За посоката $(\Leftarrow)$, според предишното твърдение,
    достатъчно е да докажем, че $\val{\tau_1} \triangleleft_{\vv{a}\to\vv{b}} \tau_2$.
    Нека $u \in \val{\vv{a}}$ и $\rho \in \text{PCF}_{\vv{a}}$, за които $u \triangleleft_{\vv{a}} \rho$.
    Ще докажем, че $\val{\tau_1}(u) \triangleleft_{\vv{b}} \tau_2\rho$.
    Понеже $\val{\tau_1} \triangleleft_{\vv{a}\to\vv{b}} \tau_1$, то
    $\val{\tau_1}(u) \triangleleft_{\vv{b}} \tau_1\rho$.
    Но понеже $\tau_1\rho \leq_{ctx} \tau_2 \rho : \vv{b}$, то от \Prop{pcf:context:relation} следва, че
    $\val{\tau_1}(u) \triangleleft_{\vv{b}} \tau_2 \rho$.
  \end{enumerate}
\end{proof}

Естсвено е да се запитаме дали можем да разширим (1) на \Prop{pcf:context:extensionality} за по-сложни от $\nat$ типове $\vv{a}$, т.е. възможно ли е
\[\tau_1 \leq_{ctx} \tau_2 : \vv{a} \iff (\forall \vv{v} : \vv{a})[\tau_1 \Downarrow_{\vv{a}} \vv{v} \implies \tau_2 \Downarrow_{\vv{a}} \vv{v}]?\]
Първо в \Prop{context:op-left-right} ще видим, че винаги имаме импликацията $(\Leftarrow)$, но по-късно в \Prop{context:op-right-left} ще видим, че дори за типа $\vv{a} = \nat\to\nat$ нямаме импликация $(\Rightarrow)$.

\begin{proposition}\label{pr:context:op-left-right}
  Докажете, че за всеки два затворени терма $\tau_1, \tau_2 \in \text{PCF}_{\vv{a}}$,
  \marginpar{$(\forall \vv{v}:\vv{a})$ означава за всяка стойност $\vv{v}$ от тип $\vv{a}$.}
  \[(\forall \vv{v}:\vv{a})[\tau_1 \Downarrow_{\vv{a}} \vv{v} \implies \tau_2 \Downarrow_{\vv{a}} \vv{v} ] \implies \tau_1 \leq_{ctx} \tau_2 : \vv{a}.\]
\end{proposition}
\begin{hint}
  Според \Prop{pcf:context:relation-characterization}, достатъчно е да докажем, че $\val{\tau_1} \triangleleft_{\vv{a}} \tau_2$.
  Но това е лесно.
  От условието имаме, че $(\forall \vv{v}:\vv{a})[\tau_1 \Downarrow_{\vv{a}} \vv{v} \implies \tau_2 \Downarrow_{\vv{a}} \vv{v}]$.
  Знаем, че $\val{\tau_1} \triangleleft_{\vv{a}} \tau_1$.
  Тогава \Prop{pcf:adequacy:implication} следва, че $\val{\tau_1} \triangleleft_{\vv{a}} \tau_2$.
\end{hint}

\begin{proposition}\label{pr:context:den-left-right}
  За произволни затворени термове $\tau_1, \tau_2$ от тип $\vv{a}$,
  \[\val{\tau_1} \sqsubseteq \val{\tau_2} \implies \tau_1 \leq_{ctx} \tau_2 : \vv{a}.\]
\end{proposition}  
\begin{proof}
  Според \Prop{pcf:context:terms}, достатъчно е да докажем, че за произволен терм $\rho \in \text{PCF}_{\vv{a}\to\nat}$,
  $\rho\tau_1 \Downarrow_{\nat} \vv{n} \implies \rho\tau_2 \Downarrow_{\nat} \vv{n}$.
  \begin{align*}
    \rho\tau_1 \Downarrow_{\nat} \vv{n} & \implies \val{\rho\tau_1} = \val{\vv{n}} & \comment\text{\hyperref[th:pcf:soundness]{Теорема за коректност}}\\
                                            & \implies \val{\rho}(\val{\tau_1}) = \val{\vv{n}} & \comment\text{\hyperref[lem:pcf:substitution]{Лема за замяната}}\\
                                            & \implies \val{\rho}(\val{\tau_2}) = \val{\vv{n}} & \comment\text{монотонност на }\val{\rho}\\
                                            & \implies \val{\rho\tau_2} = \val{\vv{n}} & \comment\text{\hyperref[lem:pcf:substitution]{Лема за замяната}}\\
                                            & \implies \rho\tau_2 \Downarrow_{\nat} \vv{n}. & \comment\text{\hyperref[th:pcf:adequacy]{Теорема за адекватност}}
  \end{align*}
\end{proof}

\begin{framed}
  \begin{theorem}\label{th:pcf:context:connection}
    За всички затворени термове $\tau_1$ и $\tau_2$ от тип $\vv{a}$ е изпълнено, че:
    \begin{enumerate}[(1)]
    \item 
      $(\forall \vv{v}:\vv{a})[\tau_1 \Downarrow_{\vv{a}} \vv{v} \iff \tau_2 \Downarrow_{\vv{a}} \vv{v} ] \implies \tau_1 \cong_{ctx} \tau_2 : \vv{a}$;
    \item
      $\val{\tau_1} = \val{\tau_2} \implies \tau_1 \cong_{ctx} \tau_2 : \vv{a}$.
    \end{enumerate}
  \end{theorem}
\end{framed}

От \Prop{pcf:context:extensionality} и от \hyperref[th:pcf:soundness]{теоремата за коректност} имаме и обратните импликации за типа $\nat$.
За съжаление, ще видим, че нямаме обратните импликации за по-високи типове от $\nat$.


\begin{proposition}\label{pr:context:op-right-left}
  $\Omega'_{\nat} \cong_{ctx} \Omega_{\nat\to\nat} : \nat \to \nat$.
\end{proposition}
\begin{proof}
  Ще използваме (2) на \Prop{pcf:context:extensionality}.
  Първо да разгледаме посоката $(\Rightarrow)$. За произволно $\rho:\nat$, ще докажем, че $\Omega'_{\nat}\rho \leq_{ctx} \Omega_{\nat\to\nat}\rho : \nat$,
  което според (1) на \Prop{pcf:context:extensionality} означава да докажем, че
  \[(\forall \vv{n})[\ \Omega'_{\nat}\rho \opsem{}{nat} \vv{n} \implies \Omega_{\nat\to\nat} \rho \opsem{}{nat} \vv{n}\ ].\]
  Да отбележим, че $\Omega'_{\nat} \rho \not\opsem{}{nat}$, защото
  \begin{prooftree}
    \AxiomC{$\Omega'_{\nat}$ е стойност}
    \UnaryInfC{$\Omega'_{\nat} \opsem{0}{nat} \Omega'_{\nat}$}
    \AxiomC{$\Omega_{\nat} \not\opsem{}{nat}$}
    \UnaryInfC{$\Omega_{\nat}\subst{x}{\rho} \not\opsem{}{nat}$}
    \BinaryInfC{$\Omega'_{\nat} \rho \not\opsem{}{nat}$}
  \end{prooftree}
  Тогава заключаваме, че за всяко такова $\rho$,
  \[(\forall \vv{n})[\ \Omega'_{\nat}\rho \Downarrow_{\nat} \vv{n} \implies \Omega_{\nat\to\nat} \rho \Downarrow_{\nat} \vv{n}\ ].\]
  Сега да разгледаме посоката $(\Leftarrow)$.
  Тук правим сходни разсъждения, защото понеже $\Omega_{\nat\to\nat} \not\Downarrow_{\nat\to\nat}$, то и $\Omega_{\nat\to\nat} \rho \not\opsem{}{nat}$.
\end{proof}


% \begin{remark}
Знаем, че $\Omega_{\nat\to\nat} \not\opsemGen{}{\nat\to\nat}$, но $\Omega'_{\nat} \opsemGen{}{\nat\to\nat} \Omega'_{\nat}$.
Това означава, че според горната задача термовете $\Omega_{\nat\to\nat}$ и $\Omega'_{\nat}$ ни дават пример кога нямаме обратната импликация в (1) на \Th{pcf:context:connection}.
Обърнете внимание, че $\val{\Omega_{\nat\to\nat}} = \val{\Omega'_{\nat}}$.
Следователно, трябва да продължим да търсим термове $\tau_1$ и $\tau_2$ от тип $\vv{a}$, за които $\val{\tau_1} \neq \val{\tau_2}$
и $\tau_1 \cong_{ctx} \tau_2 : \vv{a}$.
% \end{remark}


%%% Local Variables:
%%% mode: latex
%%% TeX-master: "../sep"
%%% End:
